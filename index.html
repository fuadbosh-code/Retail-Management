<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IT T…ôdris Proqramƒ± - Giri≈ü</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://code.edu.az/wp-content/uploads/2024/07/cropped-favicon-codeeduaz-180x180_png.webp" />
  <link rel="apple-touch-icon" href="https://code.edu.az/wp-content/uploads/2024/07/cropped-favicon-codeeduaz-180x180_png.webp" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{--green:#2ecc71;--yellow:#f1c40f;--orange:#e67e22;--red:#e74c3c;--muted:#6b7280;--blue:#2563eb;--light-blue:#eef2ff;--purple:#8b5cf6;}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;padding:20px;background:#f7fafc;color:#0f172a}
    h1{font-size:20px;margin-bottom:8px; display:inline-block;}
    .header-flex{display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:10px;}
    .container{max-width:1400px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    label{display:block;margin:8px 0 4px;font-size:13px;color:var(--muted)}
    input,select,button,textarea{padding:8px 10px;border:1px solid #e6edf3;border-radius:6px;font-size:14px;width:100%;box-sizing:border-box;}
    input[type="number"]{width:auto;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:#fff;padding:12px;border-radius:8px;border:1px solid #f0f5f9}
    table{width:100%;border-collapse:collapse;margin-top:10px;display:block;overflow-x:auto;white-space:nowrap;}
    th,td{padding:8px;border-bottom:1px solid #f3f6f8;text-align:left;font-size:13px}
    th{background:#f9fafb;font-weight:600}
    .small{font-size:12px;color:var(--muted)}
    .module-row{display:flex;gap:8px;align-items:center}
    .status-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
    .btn{background:var(--blue);color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer;font-size:13px;width:auto;}
    .btn.secondary{background:var(--light-blue);color:#111}
    .btn.danger{background:var(--red);color:#fff;}
    .btn.success{background:var(--green);color:#fff;}
    .btn.purple{background:var(--purple);color:#fff;}
    .teacher-list{max-height:160px;overflow:auto;border:1px dashed #e6eef8;padding:8px;border-radius:6px}
    .teacher-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid #f0f5f9;cursor:pointer;}
    .teacher-item:hover{background:#f9fafb;}
    .teacher-item-actions{display:flex;gap:4px;}
    .teacher-item-actions button{padding:4px 8px;font-size:11px;}
    .note-row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    footer{margin-top:20px;font-size:12px;color:var(--muted);text-align:center}
    .danger{color:var(--red)}
    .ok{color:var(--green)}
    .holiday-item{display:flex;align-items:center;margin-bottom:6px;font-size:13px}
    .holiday-item input{margin-right:8px;width:16px;height:16px}
    .group-details-container{border:1px solid #e6edf3;border-radius:6px;padding:15px;margin-top:12px;background:#fcfdff;max-height:800px;overflow-y:auto;}
    .select-status-green{background:var(--green);color:white}
    .select-status-yellow{background:var(--yellow);color:#333}
    .select-status-orange{background:var(--orange);color:white}
    .select-status-green option[value="green"]{background:var(--green);color:white}
    .select-status-green option[value="yellow"]{background:var(--yellow);color:#333}
    .select-status-green option[value="orange"]{background:var(--orange);color:white}
    .select-status-yellow option[value="green"]{background:var(--green);color:white}
    .select-status-yellow option[value="yellow"]{background:var(--yellow);color:#333}
    .select-status-yellow option[value="orange"]{background:var(--orange);color:white}
    .select-status-orange option[value="green"]{background:var(--green);color:white}
    .select-status-orange option[value="yellow"]{background:var(--yellow);color:#333}
    .select-status-orange option[value="orange"]{background:var(--orange);color:white}
    .assignment-cell{display:flex;gap:4px;align-items:center;flex-wrap:wrap;}
    .assignment-cell select{flex:1;min-width:150px;}
    .assignment-cell button{flex-shrink:0}
    .teacher-select-busy{background-color: var(--red); color: white;}
    .teacher-select-tired{background-color: var(--muted); color: white;}
    .dashboard-btn{padding: 8px 15px; background: var(--orange); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;}
    .badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-left:6px;}
    .badge-teacher{background:#e0f2fe;color:#0369a1;}
    .badge-ta{background:#fef3c7;color:#92400e;}
    .badge-both{background:#e9d5ff;color:#6b21a8;}
    .archived-group{opacity:0.6;background:#f9fafb;}
    
    /* Login Screen */
    .login-container{max-width:400px;margin:100px auto;background:#fff;padding:40px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.1)}
    .login-container h2{margin:0 0 20px;text-align:center;color:var(--blue)}
    .login-container input{margin-bottom:15px;}
    .login-container .btn{width:100%;margin-top:10px;}
    .error-msg{background:#fee;color:var(--red);padding:10px;border-radius:6px;margin-bottom:15px;font-size:13px;display:none;}
    .user-info{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--light-blue);border-radius:6px;font-size:13px;}
	  	#mainApp .header-flex{
	margin-bottom: 3rem;
}
    
    /* Modal */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);overflow:auto;}
    .modal.active{display:flex;align-items:center;justify-content:center;}
    .modal-content{background:#fff;padding:25px;border-radius:12px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .modal-header h3{margin:0;}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:auto;}
    .modal-close:hover{color:var(--red);}
    
    /* Teacher Profile */
    .profile-img-preview{width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid var(--blue);margin:10px auto;display:block;}
    .profile-img-placeholder{width:120px;height:120px;border-radius:50%;background:var(--light-blue);display:flex;align-items:center;justify-content:center;margin:10px auto;font-size:48px;color:var(--blue);}
    
    @media (max-width: 768px) {
      body{padding:10px;}
      .container{padding:12px;}
      h1{font-size:18px;}
      .header-flex{flex-direction:column;}
      .dashboard-btn{width:100%;margin-top:10px;}
      .grid{grid-template-columns:1fr;gap:12px;}
      table{font-size:11px;}
      th,td{padding:6px 4px;font-size:11px;}
      input,select,button,textarea{font-size:13px;padding:7px 8px;}
      .btn{font-size:12px;padding:7px 10px;margin:2px 0;}
      .card{padding:10px;}
      .group-details-container{padding:10px;max-height:600px;}
      .assignment-cell{flex-direction:column;align-items:stretch;}
      .assignment-cell select{width:100%;min-width:auto;}
      .assignment-cell button{width:100%;margin-top:5px;}
      .module-row{flex-direction:column;align-items:stretch;}
      .module-row div{width:100%;}
      .module-row input{width:100%!important;margin-top:5px;}
      .holiday-item{font-size:12px;}
      .teacher-list{max-height:120px;font-size:11px;}
      .login-container{margin:50px auto;padding:30px;}
      .modal-content{padding:20px;width:95%;}
    }
    
    @media (max-width: 480px) {
      body{padding:5px;}
      .container{padding:8px;border-radius:4px;}
      h1{font-size:16px;}
      .card{padding:8px;}
      table{font-size:10px;}
      th,td{padding:4px 2px;font-size:10px;}
      .small{font-size:11px;}
      input,select,button,textarea{font-size:12px;padding:6px;}
      .btn{font-size:11px;padding:6px 8px;}
      .login-container{padding:20px;}
      .modal-content{padding:15px;}
    }
    
    .hidden{display:none!important;}
    .tab-buttons{display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap;}
    .tab-btn{padding:8px 16px;background:#f0f5f9;border:1px solid #e6edf3;border-radius:6px;cursor:pointer;font-size:13px;}
    .tab-btn.active{background:var(--blue);color:#fff;border-color:var(--blue);}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
	
	/* Tab Navigation */
.main-tabs{background:#fff;border-bottom:2px solid #e6edf3;margin:-18px -18px 20px -18px;padding:0 18px;display:flex;gap:5px;position:sticky;top:0;z-index:100;}
.main-tab{padding:12px 20px;background:transparent;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:14px;font-weight:500;color:var(--muted);transition:all 0.2s;}
.main-tab:hover{color:var(--blue);background:#f9fafb;}
.main-tab.active{color:var(--blue);border-bottom-color:var(--blue);}
.tab-page{display:none;}
.tab-page.active{display:block;}
.dashboard-card{background:#fff;border:1px solid #e6edf3;border-radius:8px;padding:15px;margin-bottom:15px;}
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px;margin-bottom:20px;}
.status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;}
.status-badge.active{background:#e0f2fe;color:#0369a1;}
.status-badge.ending{background:#fef3c7;color:#92400e;}
.module-progress{background:#f0f5f9;border-radius:6px;padding:8px;margin-top:8px;}
.module-progress-bar{height:6px;background:#e6edf3;border-radius:3px;overflow:hidden;margin-top:5px;}
.module-progress-fill{height:100%;background:var(--blue);transition:width 0.3s;}
	
  </style>
</head>
<body>
  
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-container">
    <h2>üîê Giri≈ü</h2>
    <div id="loginError" class="error-msg"></div>
    <label>Email</label>
    <input type="email" id="loginEmail" placeholder="email@example.com" />
    <label>≈ûifr…ô</label>
    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    <button id="loginBtn" class="btn">Daxil ol</button>
  </div>

  <!-- MAIN APP (hidden until login) -->
  <div id="mainApp" class="hidden">
    <div class="container">
      <div class="header-flex">
        <div>
          <h1>IT T…ôdris Proqramƒ± - Modul Planlayƒ±cƒ±</h1>
          <div id="userInfo" class="user-info"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="openDashboardBtn" class="dashboard-btn">M√º…ôlliml…ôr Tablosu</button>
          <button id="openGroupsTableBtn" class="dashboard-btn">Qruplar Tablosu</button>
		  <button id="openCalendarBtn" class="dashboard-btn">üìÖ T…ôqvim</button>
          <button id="openGradingBtn" class="btn purple">Qiym…ôtl…ôndirm…ô</button>
		  <button id="openAllNotesBtn" class="btn purple">B√ºt√ºn Qeydl…ôr</button>
		  <button id="exportAllDataBtn" class="btn success">üì• B√ºt√ºn Datalarƒ± Export Et</button>
<button id="importAllDataBtn" class="btn purple">üì§ Excel-d…ôn ƒ∞mport Et</button>
<input type="file" id="importFileInput" accept=".xlsx" style="display:none;" />		  
          <button id="logoutBtn" class="btn danger">√áƒ±xƒ±≈ü</button>
        </div>
      </div>
      <!-- Tab Navigation -->
<div class="main-tabs">
  <button class="main-tab active" data-page="dashboard">üè† Ana S…ôhif…ô</button>
  <button class="main-tab" data-page="groups">üìö Qrup ∆èlav…ô Et / Redakt…ô Et</button>
  <button class="main-tab" data-page="teachers">üë• M√º…ôlliml…ôr</button>
  <button class="main-tab" data-page="holidays">üéâ R…ôsmi Bayramlar</button>
</div>

<!-- Dashboard Page -->
<div id="dashboardPage" class="tab-page active">
  <h2 style="margin-bottom:20px;">üìä Ana S…ôhif…ô - Dashboard</h2>
  <div id="dashboardContent">Y√ºkl…ônir...</div>
</div>

<!-- Groups Management Page -->
<div id="groupsPage" class="tab-page">
  <div class="grid">
    <div>
      <div class="card">
        <h3>Qrup …ôlav…ô et / redakt…ô et</h3>
        <label>Qrup adƒ±</label>
        <input id="groupName" placeholder="M…ôs: CS1-Az" />

        <label>Qrup kodu (Seans Se√ßimi)</label>
        <select id="groupCode">
          <option value="CS1">CS1 (Seans 1 - 09:00 - 13:00 - h…ôft…ô i√ßi - 4 saat/g√ºn)</option>
          <option value="CS2">CS2 (Seans 2 - 14:00 - 18:00 - h…ôft…ô i√ßi - 4 saat/g√ºn)</option>
          <option value="CS3">CS3 (Seans 3 - 19:00 - 21:45 - h…ôft…ô i√ßi - 3 saat/g√ºn)</option>
          <option value="CS4">CS4 (Seans 4 - 10:00 - 14:45 - h…ôft…ô sonu - 5 saat/g√ºn)</option>
          <option value="CS5">CS5 (Seans 5 - 15:30 - 20:15 - h…ôft…ô sonu - 5 saat/g√ºn)</option>
        </select>

       <label>Ba≈ülanƒüƒ±c tarixi (g√ºn/ay/il)</label>
<input id="startDate" placeholder="01/10/2025" />

<label>Modul sayƒ±</label>
<select id="moduleCount">
  <option value="5">5 Modul (Standart)</option>
  <option value="6">6 Modul (+ Programming Fundamentals)</option>
</select>

<label>H…ôr modul √º√ß√ºn t…ôl…ôb olunan √ºmumi saat</label>
        <div id="modulesInputs"></div>

        <div style="margin-top:10px">
          <button id="addGroupBtn" class="btn">Qrupu Yarat / Yenil…ô</button>
          <button id="clearBtn" class="btn secondary" style="margin-left:8px">Formu T…ômizl…ô</button>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="active">Aktiv Qruplar</button>
          <button class="tab-btn" data-tab="archive">Arxiv</button>
        </div>
        
        <div id="activeGroupsTab" class="tab-content active">
          <h3>Aktiv Qruplar</h3>
          <div id="groupsList" class="small"></div>
        </div>
        
        <div id="archiveTab" class="tab-content">
          <h3>Arxivl…ônmi≈ü Qruplar</h3>
          <div id="archivedGroupsList" class="small"></div>
        </div>
        
        <div class="group-details-container" id="groupDetails">Se√ßim edilm…ôyib</div>
      </div>
    </div>
  </div>
</div>

<!-- Teachers Page -->
<div id="teachersPage" class="tab-page">
  <div class="card">
    <h3>M√º…ôlliml…ôr v…ô K√∂m…ôk√ßil…ôr</h3>
    <label>Ad Soyad</label>
    <input id="teacherName" placeholder="Ad Soyad" />
    
    <label>Rol</label>
    <select id="teacherRole">
      <option value="teacher">M√º…ôllim</option>
      <option value="ta">TA (K√∂m…ôk√ßi)</option>
      <option value="both">M√º…ôllim/TA</option>
    </select>
    
    <button id="addTeacherBtn" class="btn" style="margin-top:6px">∆èlav…ô et</button>

    <label style="margin-top:8px">M√∂vcud siyahƒ±</label>
    <div id="teacherList" class="teacher-list small"></div>
  </div>
</div>

<!-- Holidays Page -->
<div id="holidaysPage" class="tab-page">
  <div class="card">
    <h3>R…ôsmi Bayramlar (Qeyri-i≈ü g√ºnl…ôri)</h3>
    <p class="small muted">Se√ßilmi≈ü bayram g√ºnl…ôri, d…ôrsl…ôrin hesablanmasƒ±nda qeyri-d…ôrs g√ºn√º (t…ôtil) kimi n…ôz…ôr…ô alƒ±nacaq.</p>
    <div style="margin-bottom: 10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="selectAllHolidaysBtn" class="btn secondary">Hamƒ±sƒ±nƒ± Se√ß</button>
      <button id="addCustomHolidayBtn" class="btn secondary">Bayram ∆èlav…ô Et</button>
      <button id="manageHolidaysBtn" class="btn secondary">ƒ∞dar…ô Et</button>
    </div>
    <div id="holidaysList" style="max-height: 250px; overflow-y: auto; padding-right: 10px; margin-top: 8px;"></div>
    <div style="margin-top: 10px;">
      <button id="saveHolidaysBtn" class="btn">Bayram Q…ôrarlarƒ±nƒ± Saxla</button>
    </div>
  </div>
</div>

      <footer>Sistem Firebase Firestore √ºz…ôrind…ô i≈ül…ôyir v…ô m…ôlumatlarƒ± sinxronla≈üdƒ±rƒ±r. üîí T…ôhl√ºk…ôsiz giri≈ü aktiv.</footer>
    </div>
  </div>

  <!-- Teacher Profile Modal -->
  <div id="teacherProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>M√º…ôllim Profili</h3>
        <button class="modal-close" onclick="closeTeacherProfile()">&times;</button>
      </div>
      <div id="teacherProfileContent"></div>
    </div>
  </div>

  <!-- Custom Holiday Modal -->
  <div id="customHolidayModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Bayram ∆èlav…ô Et</h3>
        <button class="modal-close" onclick="closeCustomHolidayModal()">&times;</button>
      </div>
      <label>Tarix (g√ºn/ay/il)</label>
      <input id="customHolidayDate" placeholder="01/01/2025" />
      <label>Bayramƒ±n adƒ±</label>
      <input id="customHolidayName" placeholder="Bayram adƒ±" />
      <div style="margin-top:15px;display:flex;gap:8px;">
        <button class="btn" onclick="saveCustomHoliday()">∆èlav…ô Et</button>
        <button class="btn secondary" onclick="closeCustomHolidayModal()">L…ôƒüv et</button>
      </div>
    </div>
  </div>

  <!-- Manage Holidays Modal -->
  <div id="manageHolidaysModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Bayramlarƒ± ƒ∞dar…ô Et</h3>
        <button class="modal-close" onclick="closeManageHolidaysModal()">&times;</button>
      </div>
      <div id="manageHolidaysContent" style="max-height:400px;overflow-y:auto;"></div>
    </div>
  </div>

  <!-- Grading Modal -->
  <div id="gradingModal" class="modal">
    <div class="modal-content" style="max-width:900px;">
      <div class="modal-header">
        <h3>Qiym…ôtl…ôndirm…ô Sistemi</h3>
        <button class="modal-close" onclick="closeGradingModal()">&times;</button>
      </div>
      <div id="gradingContent"></div>
    </div>
  </div>
  
  <!-- All Notes Modal -->
  
  <!-- Calendar Modal -->
<div id="calendarModal" class="modal">
  <div class="modal-content" style="max-width:95%;max-height:95vh;">
    <div class="modal-header">
      <h3>üìÖ T…ôqvim</h3>
      <button class="modal-close" onclick="closeCalendarModal()">&times;</button>
    </div>
    
    <div style="display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap;align-items:center;">
      <select id="calendarViewType" style="width:150px;">
		<option value="month">Ay G√∂r√ºn√º≈ü√º</option>
		<option value="year" selected>ƒ∞l G√∂r√ºn√º≈ü√º</option>
	 </select>
      
      <select id="calendarYear" style="width:120px;"></select>
      <select id="calendarMonth" style="width:150px;"></select>
      
      <select id="calendarFilter" style="width:200px;">
        <option value="all">B√ºt√ºn Qruplar</option>
      </select>
      
      <select id="calendarTeacherFilter" style="width:200px;">
        <option value="all">B√ºt√ºn M√º…ôlliml…ôr</option>
      </select>
    </div>
    
    <div id="calendarContent"></div>
    
    <div style="margin-top:15px;padding:10px;background:#f9fafb;border-radius:6px;display:flex;gap:15px;flex-wrap:wrap;font-size:12px;">
      <div><span style="display:inline-block;width:16px;height:16px;background:#10b981;border-radius:3px;margin-right:5px;"></span>D…ôrs G√ºn√º</div>
      <div><span style="display:inline-block;width:16px;height:16px;background:#a855f7;border-radius:3px;margin-right:5px;"></span>Bayram</div>
      <div><span style="display:inline-block;width:8px;height:8px;background:#f97316;border-radius:50%;margin-right:8px;"></span>Not var</div>
    </div>
  </div>
</div>

<!-- Calendar Day Details Modal -->
<div id="calendarDayModal" class="modal">
  <div class="modal-content" style="max-width:700px;">
    <div class="modal-header">
      <h3 id="calendarDayTitle"></h3>
      <button class="modal-close" onclick="closeCalendarDayModal()">&times;</button>
    </div>
    <div id="calendarDayContent"></div>
  </div>
</div>
  
<div id="allNotesModal" class="modal">
  <div class="modal-content" style="max-width:95%;max-height:90vh;">
    <div class="modal-header">
      <h3>B√ºt√ºn Qruplarƒ±n H…ôft…ôlik Qeydl…ôri</h3>
	  <button class="btn secondary" onclick="scrollToClosestDate()" style="margin-bottom:10px; float: right;">üìÖ ƒ∞ndiki Tarix…ô Yaxƒ±n Qeyd…ô Get</button>
      <button class="modal-close" onclick="closeAllNotesModal()">&times;</button>
    </div>
	
	
	
    <div id="allNotesContent" style="overflow-x:auto;"></div>
  </div>
</div>
 

<!-- Hƒ∞SS∆è 1/3 SONU -->

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCavzrvduMbpbhzNiz9b1h4smAKwt4MDxA",
      authDomain: "retail-management-dd6e1.firebaseapp.com",
      projectId: "retail-management-dd6e1",
      storageBucket: "retail-management-dd6e1.firebasestorage.app",
      messagingSenderId: "741598488693",
      appId: "1:741598488693:web:72451d3ac99d554d1e303c",
      measurementId: "G-G342WK46W2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    let state = { 
      groups:[], 
      teachers:[], 
      nonWorkingHolidays: [], 
      customHolidays: [],
      archivedGroups: [],
      grading: {},
	  calendarNotes: {},
	  dayAssignments: {} // G√ºn-g√ºn m√º…ôllim t…ôyinatlarƒ±
    };
    const GLOBAL_DOC_ID = 'global_data';
    
 const MODULES_5 = [
  'Network and Network Security Fundamentals',
  'System Engineering Fundamentals',
  'Ethical Hacking',
  'Security Engineering',
  'IT Governance'
];

const MODULES_6 = [
  'Network and Network Security Fundamentals',
  'System Engineering Fundamentals',
  'Programming Fundamentals',
  'Ethical Hacking',
  'Security Engineering',
  'IT Governance'
];

const MODULES = [...new Set([...MODULES_5, ...MODULES_6])];
    
  const DEFAULT_MODULE_HOURS = {
    'CS1/CS2': {
        'Network and Network Security Fundamentals': 48,
        'System Engineering Fundamentals': 88,
		'Programming Fundamentals': 40,
        'Ethical Hacking': 104,
        'Security Engineering': 96,
        'IT Governance': 20
    },
    'CS3': {
        'Network and Network Security Fundamentals': 51,
        'System Engineering Fundamentals': 90,
		'Programming Fundamentals': 39,
        'Ethical Hacking': 105,
        'Security Engineering': 93,
        'IT Governance': 21
    },
    'CS4/CS5': {
        'Network and Network Security Fundamentals': 50,
        'System Engineering Fundamentals': 90,
		'Programming Fundamentals': 45,
        'Ethical Hacking': 105,
        'Security Engineering': 95,
        'IT Governance': 20
    }
};

    const HOLIDAYS_RAW = [
      {date:'01/01/2025', name:'Yeni il'},{date:'02/01/2025', name:'Yeni il'},{date:'03/01/2025', name:'Yeni il'},{date:'20/01/2025', name:'Qara Yanvar'},
      {date:'08/03/2025', name:'Qadƒ±nlar g√ºn√º'},{date:'10/03/2025', name:'Qadƒ±nlar g√ºn√º (…ôv…ôz)'},{date:'20/03/2025', name:'Novruz'},{date:'21/03/2025', name:'Novruz'},
      {date:'22/03/2025', name:'Novruz'},{date:'23/03/2025', name:'Novruz'},{date:'24/03/2025', name:'Novruz'},{date:'25/03/2025', name:'Novruz'},{date:'26/03/2025', name:'Novruz'},
      {date:'30/03/2025', name:'Ramazan Bayramƒ±'},{date:'31/03/2025', name:'Ramazan Bayramƒ±'},{date:'01/04/2025', name:'Ramazan Bayramƒ±'},{date:'09/05/2025', name:'Z…ôf…ôr G√ºn√º'},
      {date:'28/05/2025', name:'Respublika G√ºn√º'},{date:'06/06/2025', name:'Qurban Bayramƒ±'},{date:'07/06/2025', name:'Qurban Bayramƒ±'},{date:'09/06/2025', name:'Qurban Bayramƒ± (…ôv…ôz)'},
      {date:'15/06/2025', name:'Milli Qurtulu≈ü G√ºn√º'},{date:'16/06/2025', name:'Milli Qurtulu≈ü G√ºn√º (…ôv…ôz)'},{date:'26/06/2025', name:'Silahlƒ± Q√ºvv…ôl…ôr G√ºn√º'},
      {date:'18/10/2025', name:'M√ºst…ôqilliyin B…ôrpasƒ± G√ºn√º'},{date:'08/11/2025', name:'Z…ôf…ôr G√ºn√º'},{date:'09/11/2025', name:'D√∂vl…ôt Bayraƒüƒ± G√ºn√º'},
      {date:'12/11/2025', name:'Konstitusiya G√ºn√º'},{date:'17/11/2025', name:'Milli Dir√ß…ôli≈ü G√ºn√º'},{date:'31/12/2025', name:'D√ºnya Az…ôrbaycanlƒ±larƒ±nƒ±n H…ômr…ôyliyi G√ºn√º'}
    ];

    function parseDateDMY(s) {const [d,m,y] = s.split('/').map(Number); return new Date(y,m-1,d);}
    function formatDateDMY(date){const d=('0'+date.getDate()).slice(-2); const m=('0'+(date.getMonth()+1)).slice(-2); const y=date.getFullYear(); return `${d}/${m}/${y}`;}
    function isHoliday(date){
      const dateStr = formatDateDMY(date); 
      if (!state.nonWorkingHolidays || state.nonWorkingHolidays.length === 0) return false; 
      return state.nonWorkingHolidays.includes(dateStr);
    }

    const SESSIONS = {
      CS1: {name:'Seans 1 - h…ôft…ô i√ßi', days:[1,2,3,4,5], hoursPerDay:4, startTime:'09:00', endTime:'13:00'},
      CS2: {name:'Seans 2 - h…ôft…ô i√ßi', days:[1,2,3,4,5], hoursPerDay:4, startTime:'14:00', endTime:'18:00'},
      CS3: {name:'Seans 3 - h…ôft…ô i√ßi', days:[1,2,3,4,5], hoursPerDay:3, startTime:'19:00', endTime:'21:45'},
      CS4: {name:'Seans 4 - h…ôft…ô sonu', days:[6,0], hoursPerDay:5, startTime:'10:00', endTime:'14:45'},
      CS5: {name:'Seans 5 - h…ôft…ô sonu', days:[6,0], hoursPerDay:5, startTime:'15:30', endTime:'20:15'}
    };
    function parseTime(timeStr) {const [h, m] = timeStr.split(':').map(Number); return h * 60 + m;}
    
    async function saveState() {
  try {
    if (!state || Object.keys(state).length === 0) {
      console.warn("Bo≈ü state yazƒ±lmadƒ±.");
      return;
    }

    if (
      (state.groups && state.groups.length) ||
      (state.teachers && state.teachers.length) ||
      (state.nonWorkingHolidays && state.nonWorkingHolidays.length) ||
      (state.customHolidays && state.customHolidays.length) ||
      (state.archivedGroups && state.archivedGroups.length)
    ) {
      await db.collection('scheduler_data').doc(GLOBAL_DOC_ID).set(state, { merge: true });
    } else {
      console.warn("He√ß bir d…ôyi≈üiklik yoxdur, yazƒ±lmadƒ±.");
    }
  } catch (e) {
    console.error("Error writing document: ", e);
    alert("X…ôta: M…ôlumatlar Firebase-…ô yazƒ±la bilm…ôdi.");
  }
}


    // AUTH MANAGEMENT
    const loginScreen = document.getElementById('loginScreen');
    const mainApp = document.getElementById('mainApp');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginError = document.getElementById('loginError');
    const userInfo = document.getElementById('userInfo');

    auth.onAuthStateChanged(user => {
      if (user) {
        loginScreen.classList.add('hidden');
        mainApp.classList.remove('hidden');
        userInfo.textContent = `üë§ ${user.email}`;
        startFirebaseListener();
      } else {
        loginScreen.classList.remove('hidden');
        mainApp.classList.add('hidden');
      }
    });

    loginBtn.onclick = async () => {
      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();
      
      if(!email || !password) {
        loginError.textContent = 'Email v…ô ≈üifr…ô daxil edin!';
        loginError.style.display = 'block';
        return;
      }

      try {
        await auth.signInWithEmailAndPassword(email, password);
        loginError.style.display = 'none';
      } catch (error) {
        loginError.textContent = 'Giri≈ü uƒüursuz oldu: ' + error.message;
        loginError.style.display = 'block';
      }
    };

    logoutBtn.onclick = () => auth.signOut();
    loginPassword.onkeypress = (e) => { if(e.key === 'Enter') loginBtn.click(); };
    
    const addGroupBtn = document.getElementById('addGroupBtn');
    const clearBtn = document.getElementById('clearBtn');
    const groupNameInput = document.getElementById('groupName');
    const groupCodeInput = document.getElementById('groupCode');
    const startDateInput = document.getElementById('startDate');
    const groupsList = document.getElementById('groupsList');
    const archivedGroupsList = document.getElementById('archivedGroupsList');
    const groupDetails = document.getElementById('groupDetails');
    const addTeacherBtn = document.getElementById('addTeacherBtn');
    const teacherNameInput = document.getElementById('teacherName');
    const teacherRoleInput = document.getElementById('teacherRole');
    const teacherListDiv = document.getElementById('teacherList');
    const holidaysListDiv = document.getElementById('holidaysList');
    const selectAllHolidaysBtn = document.getElementById('selectAllHolidaysBtn');
    const saveHolidaysBtn = document.getElementById('saveHolidaysBtn');
    const addCustomHolidayBtn = document.getElementById('addCustomHolidayBtn');
    const manageHolidaysBtn = document.getElementById('manageHolidaysBtn');
    const openDashboardBtn = document.getElementById('openDashboardBtn');
    const openGroupsTableBtn = document.getElementById('openGroupsTableBtn');
    const openGradingBtn = document.getElementById('openGradingBtn');
    const modulesInputs = document.getElementById('modulesInputs');

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab === 'active' ? 'activeGroupsTab' : 'archiveTab').classList.add('active');
      };
    });

function updateModuleHours(groupCode) {
    const moduleCount = document.getElementById('moduleCount') ? document.getElementById('moduleCount').value : '5';
    const modulesToShow = moduleCount === '6' ? MODULES_6 : MODULES_5;
    
    let defaultHours;
    if (['CS1', 'CS2'].includes(groupCode)) defaultHours = DEFAULT_MODULE_HOURS['CS1/CS2'];
    else if (groupCode === 'CS3') defaultHours = DEFAULT_MODULE_HOURS['CS3'];
    else if (['CS4', 'CS5'].includes(groupCode)) defaultHours = DEFAULT_MODULE_HOURS['CS4/CS5'];
    else defaultHours = modulesToShow.reduce((acc, m) => { acc[m] = 40; return acc; }, {});

    modulesInputs.innerHTML = '';
    modulesToShow.forEach(m => {
        const defaultVal = defaultHours[m] || 40;
        const div = document.createElement('div'); 
        div.className='module-row';
        div.innerHTML = `<div style="flex:1"><label>${m}</label></div><input type="number" min="1" value="${defaultVal}" data-module="${m}" style="width:110px" />`;
        modulesInputs.appendChild(div);
    });
}

    groupCodeInput.onchange = (e) => updateModuleHours(e.target.value);

// BU S∆èTRƒ∞ ∆èLAV∆è EDƒ∞N:
document.addEventListener('DOMContentLoaded', function() {
    const moduleCountSelect = document.getElementById('moduleCount');
    if (moduleCountSelect) {
        moduleCountSelect.onchange = () => updateModuleHours(groupCodeInput.value);
    }
});
    
    function getRoleBadge(role) {
      if (role === 'teacher') return '<span class="badge badge-teacher">M√º…ôllim</span>';
      if (role === 'ta') return '<span class="badge badge-ta">TA</span>';
      if (role === 'both') return '<span class="badge badge-both">M√º…ôllim/TA</span>';
      return '<span class="badge badge-teacher">M√º…ôllim</span>';
    }

    function renderTeachers(){
      teacherListDiv.innerHTML = '';
      state.teachers.forEach((t, idx)=>{
        const div = document.createElement('div');
        div.className = 'teacher-item';
        div.innerHTML = `
          <div onclick="openTeacherProfile(${idx})" style="flex:1;cursor:pointer;">
            <strong>${t.name}</strong> ${getRoleBadge(t.role || 'teacher')}
            ${t.note ? '<div class="small muted">'+t.note+'</div>' : ''}
          </div>
          <div class="teacher-item-actions">
            <button class="btn secondary" onclick="openTeacherProfile(${idx})">Profil</button>
            <button class="btn secondary" onclick="editTeacher(${idx})">D√ºz…ôlt</button>
            <button class="btn danger" onclick="deleteTeacher(${idx})">Sil</button>
          </div>
        `;
        teacherListDiv.appendChild(div);
      });
    }

    function deleteTeacher(idx) {
      if (!confirm('Bu m√º…ôllimi silm…ôk ist…ôdiyinizd…ôn …ôminsiniz?')) return;
      
      const teacherName = state.teachers[idx].name;
      let hasAssignments = false;
      
      state.groups.forEach(g => {
        if (g.assignments) {
          Object.values(g.assignments).forEach(assigned => {
            if (assigned === teacherName) hasAssignments = true;
          });
        }
        if (g.taAssignments) {
          Object.values(g.taAssignments).forEach(assigned => {
            if (assigned === teacherName) hasAssignments = true;
          });
        }
      });

      if (hasAssignments) {
        if (!confirm('Bu m√º…ôllim qruplarda t…ôyin olunub. Yen…ô d…ô silm…ôk ist…ôyirsiniz? (T…ôyinatlar silin…ôc…ôk)')) return;
        
        state.groups.forEach(g => {
          if (g.assignments) {
            Object.keys(g.assignments).forEach(mod => {
              if (g.assignments[mod] === teacherName) delete g.assignments[mod];
            });
          }
          if (g.taAssignments) {
            Object.keys(g.taAssignments).forEach(mod => {
              if (g.taAssignments[mod] === teacherName) delete g.taAssignments[mod];
            });
          }
        });
      }

      state.teachers.splice(idx, 1);
      saveState();
    }

    function editTeacher(idx) {
      const teacher = state.teachers[idx];
      const newName = prompt('Yeni ad daxil edin:', teacher.name);
      if (!newName || newName.trim() === '') return;
      
      const trimmedName = newName.trim();
      if (state.teachers.some((t, i) => t.name === trimmedName && i !== idx)) {
        alert('Bu adda m√º…ôllim artƒ±q m√∂vcuddur!');
        return;
      }

      const oldName = teacher.name;
      teacher.name = trimmedName;

      state.groups.forEach(g => {
        if (g.assignments) {
          Object.keys(g.assignments).forEach(mod => {
            if (g.assignments[mod] === oldName) g.assignments[mod] = trimmedName;
          });
        }
        if (g.taAssignments) {
          Object.keys(g.taAssignments).forEach(mod => {
            if (g.taAssignments[mod] === oldName) g.taAssignments[mod] = trimmedName;
          });
        }
      });

      saveState();
    }

    function openTeacherProfile(idx) {
      const teacher = state.teachers[idx];
      const modal = document.getElementById('teacherProfileModal');
      const content = document.getElementById('teacherProfileContent');
      
      content.innerHTML = `
        <div style="text-align:center;">
          ${teacher.photoURL ? 
            `<img src="${teacher.photoURL}" class="profile-img-preview" alt="Profil ≈ü…ôkli" />` : 
            `<div class="profile-img-placeholder">üë§</div>`
          }
          <input type="file" id="profilePhotoInput" accept="image/*" style="margin:10px auto;display:block;width:200px;" />
        </div>
        
        <label>Ad Soyad</label>
        <input id="profileName" value="${teacher.name}" />
        
        <label>Rol</label>
        <select id="profileRole">
          <option value="teacher" ${(teacher.role || 'teacher') === 'teacher' ? 'selected' : ''}>M√º…ôllim</option>
          <option value="ta" ${teacher.role === 'ta' ? 'selected' : ''}>TA</option>
          <option value="both" ${teacher.role === 'both' ? 'selected' : ''}>M√º…ôllim/TA</option>
        </select>
        
        <label>Email</label>
        <input id="profileEmail" type="email" value="${teacher.email || ''}" placeholder="email@example.com" />
        
        <label>Telefon</label>
        <input id="profilePhone" value="${teacher.phone || ''}" placeholder="+994..." />
        
        <label>Haqqƒ±nda</label>
        <textarea id="profileBio" rows="3" placeholder="Qƒ±sa m…ôlumat...">${teacher.bio || ''}</textarea>
        
        <label>Qeyd</label>
        <input id="profileNote" value="${teacher.note || ''}" placeholder="Daxili qeyd" />
        
        <div style="margin-top:20px;display:flex;gap:8px;">
          <button class="btn" onclick="saveTeacherProfile(${idx})">Yadda saxla</button>
          <button class="btn secondary" onclick="closeTeacherProfile()">Baƒüla</button>
        </div>
      `;
      
      modal.classList.add('active');
    }

    function closeTeacherProfile() {
      document.getElementById('teacherProfileModal').classList.remove('active');
    }

   async function saveTeacherProfile(idx) {
  const teacher = state.teachers[idx];
  const fileInput = document.getElementById('profilePhotoInput');
  
  teacher.name = document.getElementById('profileName').value.trim();
  teacher.role = document.getElementById('profileRole').value;
  teacher.email = document.getElementById('profileEmail').value.trim();
  teacher.phone = document.getElementById('profilePhone').value.trim();
  teacher.bio = document.getElementById('profileBio').value.trim();
  teacher.note = document.getElementById('profileNote').value.trim();

  // ≈û∆èKƒ∞L Y√úKL∆èM∆è Hƒ∞SS∆èSƒ∞ D∆èYƒ∞≈ûDƒ∞
  if (fileInput.files && fileInput.files[0]) {
    const file = fileInput.files[0];
    
    // ≈û…ôklin √∂l√ß√ºs√ºn√º yoxla (max 500KB)
    if (file.size > 500000) {
      alert('≈û…ôkil √ßox b√∂y√ºkd√ºr! 500KB-dan ki√ßik olmalƒ±dƒ±r.');
      return;
    }
    
    // ≈û…ôkli Base64-…ô √ßevir
    const reader = new FileReader();
    reader.onload = async function(e) {
      teacher.photoURL = e.target.result; // Base64 formatda saxla
      await saveState();
      closeTeacherProfile();
      renderTeachers();
      alert('Profil yenil…ôndi! ‚úÖ');
    };
    reader.readAsDataURL(file);
    return; // Funksiyadan √ßƒ±x
  }

  await saveState();
  closeTeacherProfile();
  renderTeachers();
  alert('Profil yenil…ôndi! ‚úÖ');
}
    
    function getAllHolidays() {
      const base = [...HOLIDAYS_RAW];
      const custom = (state.customHolidays || []).map(h => ({date: h.date, name: h.name + ' (X√ºsusi)'}));
      return [...base, ...custom];
    }

    function renderHolidays(){
        holidaysListDiv.innerHTML = '';
        const allHolidays = getAllHolidays();
        allHolidays.forEach(h => {
            const isChecked = state.nonWorkingHolidays && state.nonWorkingHolidays.includes(h.date);
            const div = document.createElement('div');
            div.className = 'holiday-item';
            div.innerHTML = `<input type="checkbox" data-holiday-date="${h.date}" ${isChecked ? 'checked' : ''} /><span class="muted">${h.date}</span> - <strong>${h.name}</strong>`;
            holidaysListDiv.appendChild(div);
        });
    }
    
    function selectAllHolidaysHandler(){
        state.nonWorkingHolidays = getAllHolidays().map(h => h.date);
        saveState();
        renderHolidays(); 
        alert('B√ºt√ºn bayramlar se√ßildi v…ô saxlanƒ±ldƒ±.');
    }

    function saveHolidayDecisions(){
        state.nonWorkingHolidays = [];
        document.querySelectorAll('#holidaysList input[type="checkbox"]:checked').forEach(input => {
            state.nonWorkingHolidays.push(input.dataset.holidayDate);
        });
        saveState();
        alert('Bayram q…ôrarlarƒ± saxlanƒ±ldƒ± v…ô Firebase-…ô yazƒ±ldƒ±.');
    }
    
    selectAllHolidaysBtn.onclick = selectAllHolidaysHandler;
    saveHolidaysBtn.onclick = saveHolidayDecisions;
    addCustomHolidayBtn.onclick = () => document.getElementById('customHolidayModal').classList.add('active');
    manageHolidaysBtn.onclick = openManageHolidays;

    function closeCustomHolidayModal() {
      document.getElementById('customHolidayModal').classList.remove('active');
      document.getElementById('customHolidayDate').value = '';
      document.getElementById('customHolidayName').value = '';
    }

    function saveCustomHoliday() {
      const date = document.getElementById('customHolidayDate').value.trim();
      const name = document.getElementById('customHolidayName').value.trim();
      
      if (!date || !name) {
        alert('Tarix v…ô ad daxil edin!');
        return;
      }
      
      if (!/^\d{2}\/\d{2}\/\d{4}$/.test(date)) {
        alert('Tarix formatƒ± dd/mm/yyyy olmalƒ±dƒ±r');
        return;
      }

      state.customHolidays = state.customHolidays || [];
      if (state.customHolidays.some(h => h.date === date)) {
        alert('Bu tarix artƒ±q …ôlav…ô edilib!');
        return;
      }

      state.customHolidays.push({date, name});
      saveState();
      renderHolidays();
      closeCustomHolidayModal();
      alert('Bayram …ôlav…ô edildi!');
    }

    function openManageHolidays() {
      const modal = document.getElementById('manageHolidaysModal');
      const content = document.getElementById('manageHolidaysContent');
      
      if (!state.customHolidays || state.customHolidays.length === 0) {
        content.innerHTML = '<p class="muted">X√ºsusi bayram …ôlav…ô edilm…ôyib.</p>';
      } else {
        let html = '<table><thead><tr><th>Tarix</th><th>Ad</th><th>∆èm…ôliyyat</th></tr></thead><tbody>';
        state.customHolidays.forEach((h, idx) => {
          html += `<tr><td>${h.date}</td><td>${h.name}</td><td><button class="btn danger" style="width:auto;padding:4px 8px;" onclick="deleteCustomHoliday(${idx})">Sil</button></td></tr>`;
        });
        html += '</tbody></table>';
        content.innerHTML = html;
      }
      
      modal.classList.add('active');
    }

    function closeManageHolidaysModal() {
      document.getElementById('manageHolidaysModal').classList.remove('active');
    }

    function deleteCustomHoliday(idx) {
      if (!confirm('Bu bayramƒ± silm…ôk ist…ôdiyinizd…ôn …ôminsiniz?')) return;
      state.customHolidays.splice(idx, 1);
      saveState();
      renderHolidays();
      openManageHolidays();
    }

    function renderGroups(){
      groupsList.innerHTML='';
      archivedGroupsList.innerHTML='';
      
      const activeGroups = state.groups.filter(g => !g.archived);
      const archived = state.groups.filter(g => g.archived);

      activeGroups.forEach((g,idx)=>{
        const realIdx = state.groups.indexOf(g);
        const el = document.createElement('div');
        el.style.padding='8px'; el.style.borderBottom='1px dashed #eef2f7';
        el.innerHTML = `<strong>${g.name}</strong> <div class="small muted">${SESSIONS[g.code].startTime}-${SESSIONS[g.code].endTime} (${g.code}) ‚Äì Ba≈ü: ${g.startDate}</div><div style="margin-top:6px"><button data-idx="${realIdx}" class="btn normal-open-btn">Normal A√ß</button> <button data-idx="${realIdx}" class="btn secondary popup-open-btn">P…ônc…ôr…ô Kimi A√ß</button><button data-archive="${realIdx}" class="btn secondary">Arxivl…ô</button><button data-del="${realIdx}" class="btn danger">Sil</button></div>`;
        groupsList.appendChild(el);
      });

      if (archived.length === 0) {
        archivedGroupsList.innerHTML = '<p class="muted small">Arxivl…ônmi≈ü qrup yoxdur.</p>';
      } else {
        archived.forEach((g)=>{
          const realIdx = state.groups.indexOf(g);
          const el = document.createElement('div');
          el.className = 'archived-group';
          el.style.padding='8px'; el.style.borderBottom='1px dashed #eef2f7';
          el.innerHTML = `<strong>${g.name}</strong> <span class="badge" style="background:#94a3b8;color:white;">Arxiv</span><div class="small muted">${SESSIONS[g.code].startTime}-${SESSIONS[g.code].endTime} (${g.code}) ‚Äì Ba≈ü: ${g.startDate}</div><div style="margin-top:6px"><button data-idx="${realIdx}" class="btn secondary normal-open-btn">Bax</button><button data-restore="${realIdx}" class="btn success">Geri qaytƒ±r</button><button data-del="${realIdx}" class="btn danger">Sil</button></div>`;
          archivedGroupsList.appendChild(el);
        });
      }
    }

<!-- Hƒ∞SS∆è 2/3 SONU -->

function computeScheduleForGroup(group){
        const session = SESSIONS[group.code];
        const dailyHours = session.hoursPerDay;
        const allowedWeekdays = session.days; 
        const result = [];
        let curDate = parseDateDMY(group.startDate);
        
        function advanceToAllowed(date){
            let d = new Date(date);
            while(true){
                const wd = d.getDay(); 
                if(allowedWeekdays.includes(wd) && !isHoliday(d)) return d; 
                d.setDate(d.getDate()+1);
            }
        }
        curDate = advanceToAllowed(curDate);

    // Qrupun modul sayƒ±nƒ± m√º…ôyy…ôn et
    const modulesToUse = group.moduleCount === 6 ? MODULES_6 : MODULES_5;

    for(const module of modulesToUse){
            const hours = Number(group.moduleHours[module]||40);
            const daysNeeded = Math.ceil(hours / dailyHours);
            const start = new Date(curDate);
            let usedDays=0;
            let lastDay = new Date(start);
            while(usedDays < daysNeeded){
                const wd = curDate.getDay();
                if(allowedWeekdays.includes(wd) && !isHoliday(curDate)){
                    lastDay = new Date(curDate);
                    usedDays++;
                }
                curDate.setDate(curDate.getDate()+1);
            }
            curDate = advanceToAllowed(curDate);
            result.push({
              module, 
              start:formatDateDMY(start), 
              end:formatDateDMY(lastDay), 
              hours, 
              daysUsed:daysNeeded, 
              teacher: (group.assignments && group.assignments[module])||null,
              ta: (group.taAssignments && group.taAssignments[module])||null,
              sessionTime: `${session.startTime}-${session.endTime}`, 
              groupName: group.name, 
              groupCode: group.code
            });
        }
        
		// Layih…ô m…ôrh…ôl…ôl…ôrini …ôlav…ô et
if (result.length > 0) {
  const lastModule = result[result.length - 1];
  const lastModuleEnd = parseDateDMY(lastModule.end);
  
  // 1 h…ôft…ô istirah…ôt
  const restStart = new Date(lastModuleEnd);
  restStart.setDate(restStart.getDate() + 1);
  const restEnd = new Date(restStart);
  restEnd.setDate(restEnd.getDate() + 6);
  
  // Layih…ô i≈üi (40 g√ºn)
  const projectStart = new Date(restEnd);
  projectStart.setDate(projectStart.getDate() + 1);
  const projectEnd = new Date(projectStart);
  projectEnd.setDate(projectEnd.getDate() + 39);
  
  // T…ôqdimat g√ºn√º
  const presentationDate = new Date(projectEnd);
  presentationDate.setDate(presentationDate.getDate() + 1);
  
  result.push({
    module: 'üèñÔ∏è ƒ∞stirah…ôt',
    start: formatDateDMY(restStart),
    end: formatDateDMY(restEnd),
    hours: 0,
    daysUsed: 7,
    teacher: null,
    ta: null,
    sessionTime: '-',
    groupName: group.name,
    groupCode: group.code,
    isRest: true
  });
  
  result.push({
    module: 'üíº Layih…ô ƒ∞≈üi',
    start: formatDateDMY(projectStart),
    end: formatDateDMY(projectEnd),
    hours: 0,
    daysUsed: 40,
    teacher: null,
    ta: null,
    sessionTime: '-',
    groupName: group.name,
    groupCode: group.code,
    isProject: true
  });
  
  result.push({
    module: 'üéì T…ôqdimat G√ºn√º',
    start: formatDateDMY(presentationDate),
    end: formatDateDMY(presentationDate),
    hours: 0,
    daysUsed: 1,
    teacher: null,
    ta: null,
    sessionTime: '-',
    groupName: group.name,
    groupCode: group.code,
    isPresentation: true
  });
}
		
		return result;
    }
    
    function renderGroupDetails(idx, targetElement){
      const g = state.groups[idx];
      if(!g) { targetElement.textContent='Se√ßim edilm…ôyib'; return; }
      const schedule = computeScheduleForGroup(g);
      
      let html = `<h3>${g.name} T…ôf…ôrr√ºatlarƒ±</h3><div style="margin-bottom:15px"><strong>${g.name}</strong> ‚Äì ${SESSIONS[g.code].startTime}-${SESSIONS[g.code].endTime} (${g.code}) ‚Äì Ba≈ülanƒüƒ±c: ${g.startDate}</div>`;
      
      html += `<h4>Modul C…ôdv…ôli v…ô M√º…ôllim T…ôyinatƒ±</h4><table><thead><tr><th>Modul</th><th>Ba≈ülama</th><th>Biti≈ü</th><th>Saat Aralƒ±ƒüƒ±</th><th>Saat</th><th>G√ºnl…ôr</th><th>M√º…ôllim</th><th>TA</th></tr></thead><tbody>`;
      
      schedule.forEach(s=>{
        const teachers = state.teachers.filter(t => !t.role || t.role === 'teacher' || t.role === 'both');
        const tas = state.teachers.filter(t => t.role === 'ta' || t.role === 'both');

        let teacherSelectHtml = '<select data-mod="'+s.module+'" data-type="teacher">';
        teacherSelectHtml += '<option value="">-- m√º…ôllim se√ß --</option>';
        teachers.forEach(t => {
            const isAvailable = isTeacherAvailable(t.name, s).available;
            const isWithinLimit = checkDailyAssignmentLimit(t.name, s).withinLimit;
            let className = '';
            if (!isAvailable) { className = 'teacher-select-busy'; } 
            else if (!isWithinLimit) { className = 'teacher-select-tired'; }
            teacherSelectHtml += `<option value="${t.name}" class="${className}" ${s.teacher === t.name ? 'selected' : ''}>${t.name}</option>`;
        });
        teacherSelectHtml += '</select>';

        let taSelectHtml = '<select data-mod="'+s.module+'" data-type="ta">';
        taSelectHtml += '<option value="">-- TA se√ß --</option>';
        tas.forEach(t => {
            const isAvailable = isTeacherAvailable(t.name, s).available;
            const isWithinLimit = checkDailyAssignmentLimit(t.name, s).withinLimit;
            let className = '';
            if (!isAvailable) { className = 'teacher-select-busy'; } 
            else if (!isWithinLimit) { className = 'teacher-select-tired'; }
            taSelectHtml += `<option value="${t.name}" class="${className}" ${s.ta === t.name ? 'selected' : ''}>${t.name}</option>`;
        });
        taSelectHtml += '</select>';

        const teacherCell = s.teacher ? 
          `${s.teacher} <button class="btn secondary" style="padding:4px 8px;font-size:11px;" data-change-teacher="${s.module}" data-group-idx="${idx}">D…ôyi≈ü</button>` : 
          teacherSelectHtml + '<button class="assignBtn" data-mod="'+s.module+'" data-group-idx="'+idx+'" data-type="teacher">T…ôyin et</button>';

        const taCell = s.ta ? 
          `${s.ta} <button class="btn secondary" style="padding:4px 8px;font-size:11px;" data-change-ta="${s.module}" data-group-idx="${idx}">D…ôyi≈ü</button>` : 
          taSelectHtml + '<button class="assignBtn" data-mod="'+s.module+'" data-group-idx="'+idx+'" data-type="ta">T…ôyin et</button>';

        html += `<tr><td>${s.module}</td><td>${s.start}</td><td>${s.end}</td><td>${s.sessionTime}</td><td>${s.hours}</td><td>${s.daysUsed}</td><td class="assignment-cell">${teacherCell}</td><td class="assignment-cell">${taCell}</td></tr>`;
      });
      html += `</tbody></table>`;
      
      html += `<div style="margin-top: 15px;"><button class="btn bulkAssignBtn" data-group-idx="${idx}">B√ºt√ºn Se√ßilmi≈ü Modullarƒ± T…ôyin et</button></div>`;

      // H…ôft…ôlik Qeydl…ôr B√∂lm…ôsi
      const progStart = parseDateDMY(g.startDate);
      const progEnd = parseDateDMY(schedule[schedule.length-1].end);
      const notes = g.weeklyNotes || {};
      
      html += `<h4 style="margin-top:20px;border-top:2px solid #e6edf3;padding-top:15px;">H…ôft…ôlik Qeydl…ôr (√á…ôr≈ü…ônb…ô ax≈üamƒ± g√ºnl…ôri)</h4>`;
      html += `<p class="small muted">Proqram m√ºdd…ôti: ${g.startDate} - ${formatDateDMY(progEnd)}</p>`;
      
      // B√ºt√ºn √á…ôr≈ü…ônb…ô ax≈üamƒ± g√ºnl…ôrini tap
      const rows = [];
      let cur = new Date(progStart);
      
      // ƒ∞lk √á…ôr≈ü…ônb…ô ax≈üamƒ±nƒ± tap
      while(cur.getDay() !== 2) {
        cur.setDate(cur.getDate() + 1);
      }
      
      // B√ºt√ºn √á…ôr≈ü…ônb…ô ax≈üamlarƒ±nƒ± topla
      while(cur <= progEnd){
        if(cur >= progStart) {
          const key = formatDateDMY(cur);
          const entry = notes[key] || {status:'yellow', text:''}; 
          rows.push({date: key, entry: entry});
        }
        cur.setDate(cur.getDate() + 7); // N√∂vb…ôti h…ôft…ôy…ô ke√ß
      }
      
      if(rows.length === 0) {
        html += '<div class="muted" style="padding:10px;background:#f9fafb;border-radius:6px;">Proqram m√ºdd…ôtind…ô he√ß bir √á…ôr≈ü…ônb…ô ax≈üamƒ± g√ºn√º yoxdur.</div>';
      } else {
        html += '<div style="background:#fcfdff;padding:12px;border-radius:6px;border:1px solid #e6edf3;">';
        html += `<p class="small" style="margin-bottom:10px;"><strong>${rows.length}</strong> h…ôft…ôlik qeyd n√∂qt…ôsi tapƒ±ldƒ±:</p>`;
        
        rows.forEach((r, idx) => {
          html += `<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;padding:8px;background:#fff;border-radius:4px;border:1px solid #f0f5f9;">
                    <div style="width:30px;text-align:center;font-weight:600;color:var(--muted);">${idx + 1}</div>
                    <div style="width:100px;flex-shrink:0;font-size:13px;">${r.date}</div>
                    <select data-note="${r.date}" class="select-status-${r.entry.status}" style="width:140px;flex-shrink:0;">
                      <option value="green" ${r.entry.status==='green'?'selected':''}>‚úì H…ôll olundu</option>
                      <option value="yellow" ${r.entry.status==='yellow'?'selected':''}>‚è≥ G…ôl…ôn h…ôft…ô</option>
                      <option value="orange" ${r.entry.status==='orange'?'selected':''}>‚ö†Ô∏è Bu h…ôft…ô H∆èLL</option>
                    </select>
                    <input data-note-text="${r.date}" placeholder="Qeyd v…ô ya problemin t…ôsviri..." value="${r.entry.text||''}" style="flex:1;min-width:200px;"/>
                  </div>`;
        });
        
        html += `<div style="margin-top:12px;text-align:right;">
                  <button class="btn saveNotesBtn">üíæ B√ºt√ºn Qeydl…ôri Saxla</button>
                </div>`;
        html += '</div>';
      }

      targetElement.innerHTML = html;
      attachGroupDetailsListeners(idx, targetElement);
      
      targetElement.querySelectorAll('[data-note]').forEach(sel=>{
        const updateStatusColor = ()=>{ sel.className = 'select-status-' + sel.value; }
        sel.onchange = updateStatusColor;
        updateStatusColor(); 
      });

      return html; 
    }

    function attachGroupDetailsListeners(idx, container) {
        container.querySelectorAll('.assignBtn').forEach(b=>{
            b.removeEventListener('click', handleSingleAssignment); 
            b.addEventListener('click', handleSingleAssignment);
        });
        
        container.querySelectorAll('[data-change-teacher]').forEach(b=>{
            b.addEventListener('click', (e) => {
                const mod = e.currentTarget.dataset.changeTeacher;
                const groupIdx = Number(e.currentTarget.dataset.groupIdx);
                changeAssignment(groupIdx, mod, 'teacher', container);
            });
        });

        container.querySelectorAll('[data-change-ta]').forEach(b=>{
            b.addEventListener('click', (e) => {
                const mod = e.currentTarget.dataset.changeTa;
                const groupIdx = Number(e.currentTarget.dataset.groupIdx);
                changeAssignment(groupIdx, mod, 'ta', container);
            });
        });

        const bulkAssignBtn = container.querySelector('.bulkAssignBtn');
        if (bulkAssignBtn) {
            bulkAssignBtn.removeEventListener('click', handleBulkAssignment);
            bulkAssignBtn.addEventListener('click', handleBulkAssignment);
        }
        const saveNotesBtn = container.querySelector('.saveNotesBtn');
        if(saveNotesBtn){
            saveNotesBtn.removeEventListener('click', () => saveNotesHandler(idx, container));
            saveNotesBtn.addEventListener('click', () => saveNotesHandler(idx, container));
        }
    }

    function changeAssignment(groupIndex, moduleName, type, container) {
        const g = state.groups[groupIndex];
        const assignmentKey = type === 'teacher' ? 'assignments' : 'taAssignments';
        
        if (g[assignmentKey] && g[assignmentKey][moduleName]) {
            delete g[assignmentKey][moduleName];
        }
        
        saveState();
        
        const isPopup = container.ownerDocument !== document;
        if (isPopup) {
            container.ownerDocument.defaultView.renderContent();
        } else {
            renderGroupDetails(groupIndex, container);
        }
    }
    
    function saveNotesHandler(idx, container) {
        const g = state.groups[idx];
        g.weeklyNotes = g.weeklyNotes || {};
        
        let shouldReRenderPopup = (container.closest('body') !== document.body); 

        container.querySelectorAll('[data-note]').forEach(sel=>{
            const date = sel.dataset.note;
            const status = sel.value;
            const text = container.querySelector(`[data-note-text="${date}"]`).value;
            g.weeklyNotes[date] = {status: status, text};
        });
        saveState(); 
        alert('Qeydl…ôr saxlanƒ±ldƒ±'); 
        
        if (shouldReRenderPopup) {
            const win = container.ownerDocument.defaultView;
            if (win && win.renderContent) win.renderContent();
        } else {
            renderGroupDetails(idx, groupDetails); 
        }
    }

    function assignModule(groupIndex, moduleName, teacherName, type = 'teacher') {
        const g = state.groups[groupIndex];
        const modSched = computeScheduleForGroup(g).find(x=>x.module===moduleName);
        
        const availabilityCheck = isTeacherAvailable(teacherName, modSched);
        if(!availabilityCheck.available) {
            return { success: false, message: availabilityCheck.message };
        }
        
        const dailyLimitCheck = checkDailyAssignmentLimit(teacherName, modSched);
        if(!dailyLimitCheck.withinLimit) {
            return { success: false, message: dailyLimitCheck.message };
        }
        
        if (type === 'teacher') {
            g.assignments = g.assignments || {};
            g.assignments[moduleName] = teacherName;
        } else {
            g.taAssignments = g.taAssignments || {};
            g.taAssignments[moduleName] = teacherName;
        }
        
        return { success: true };
    }

    function handleSingleAssignment(e) {
        const btn = e.currentTarget;
        const mod = btn.dataset.mod;
        const groupIndex = Number(btn.dataset.groupIdx);
        const type = btn.dataset.type || 'teacher';
        
        const sel = btn.parentElement.querySelector(`select[data-mod="${mod}"][data-type="${type}"]`);
        const teacher = sel.value;
        
        if(!teacher){ alert('M√º…ôllim se√ßin'); return; }

        const result = assignModule(groupIndex, mod, teacher, type);

        if (result.success) {
            saveState(); 
            alert(`T…ôyinat uƒüurlu oldu: ${teacher} -> ${mod} (${type === 'teacher' ? 'M√º…ôllim' : 'TA'})`);
            
            const isPopup = e.view && e.view.name === "GroupDetailsPopup";
            if (isPopup) {
                e.view.renderContent(); 
            } else {
                renderGroupDetails(groupIndex, groupDetails); 
            }
        } else {
            alert(result.message);
        }
    }
    
    function handleBulkAssignment(e) {
        const groupIndex = Number(e.currentTarget.dataset.groupIdx);
        const g = state.groups[groupIndex];
        const modulesToAssign = [];
        let firstConflict = null;

        const container = e.currentTarget.closest('.group-details-container') || e.currentTarget.closest('body'); 
        
        container.querySelectorAll('select[data-mod]').forEach(sel => {
            const mod = sel.dataset.mod;
            const teacher = sel.value;
            const type = sel.dataset.type || 'teacher';
            const assignmentKey = type === 'teacher' ? 'assignments' : 'taAssignments';
            
            if (teacher && (!g[assignmentKey] || g[assignmentKey][mod] !== teacher)) { 
                modulesToAssign.push({ module: mod, teacher: teacher, type: type });
            }
        });
        
        if (modulesToAssign.length === 0) {
            alert('T…ôyin edil…ôc…ôk se√ßilmi≈ü modul tapƒ±lmadƒ±. M√º…ôllimi se√ßin v…ô modulun t…ôyin olunmadƒ±ƒüƒ±ndan …ômin olun.');
            return;
        }

        for (const item of modulesToAssign) {
            const modSched = computeScheduleForGroup(g).find(x => x.module === item.module);
            
            const availabilityCheck = isTeacherAvailable(item.teacher, modSched);
            if (!availabilityCheck.available) {
                firstConflict = { module: item.module, message: availabilityCheck.message };
                break;
            }
            
            const dailyLimitCheck = checkDailyAssignmentLimit(item.teacher, modSched);
            if (!dailyLimitCheck.withinLimit) {
                firstConflict = { module: item.module, message: dailyLimitCheck.message };
                break;
            }
        }

        if (firstConflict) {
            alert(`K√ºtl…ôvi t…ôyinat m√ºmk√ºn olmadƒ±. ${firstConflict.module} modulunda toqqu≈üma/limit a≈üƒ±mƒ± a≈ükarlandƒ±: \n\n${firstConflict.message}`);
            return;
        }
        
        let assignmentsCount = 0;
        modulesToAssign.forEach(item => {
            if (item.type === 'teacher') {
                g.assignments = g.assignments || {};
                g.assignments[item.module] = item.teacher;
            } else {
                g.taAssignments = g.taAssignments || {};
                g.taAssignments[item.module] = item.teacher;
            }
            assignmentsCount++;
        });

        if (assignmentsCount > 0) {
            saveState(); 
            
            const isPopup = e.view && e.view.name === "GroupDetailsPopup";
            if (isPopup) {
                e.view.renderContent();
            } else {
                renderGroupDetails(groupIndex, groupDetails);
            }
            
            alert(`${assignmentsCount} modul √º√ß√ºn k√ºtl…ôvi t…ôyinat uƒüurla yerin…ô yetirildi!`);
        }
    }
    
    function checkDailyAssignmentLimit(teacherName, moduleSchedule){
        const s1 = parseDateDMY(moduleSchedule.start);
        const e1 = parseDateDMY(moduleSchedule.end);
        const proposedGroupName = moduleSchedule.groupName; 
        const teacherDailyLoad = {}; 

        for(const g of state.groups){
            if (g.archived) continue;
            const gSchedule = computeScheduleForGroup(g);
            const gModules = g.moduleCount === 6 ? MODULES_6 : MODULES_5;
for(const m of gModules){
                let isAssigned = false;
                if(g.assignments && g.assignments[m] === teacherName) isAssigned = true;
                if(g.taAssignments && g.taAssignments[m] === teacherName) isAssigned = true;
                
                if(isAssigned){
                    const sched = gSchedule.find(x=>x.module===m);
                    if(!sched) continue;
                    
                    const isCurrentModule = (g.name === proposedGroupName && m === moduleSchedule.module);
                    if (isCurrentModule) continue; 

                    const sessionTimes = SESSIONS[g.code];
                    const allowedWeekdays = sessionTimes.days;
                    
                    let cur = parseDateDMY(sched.start);
                    const end = parseDateDMY(sched.end);
                    while(cur <= end){
                        const wd = cur.getDay();
                        if(allowedWeekdays.includes(wd) && !isHoliday(cur)){
                            const dateStr = formatDateDMY(cur);
                            teacherDailyLoad[dateStr] = (teacherDailyLoad[dateStr] || 0) + 1;
                        }
                        cur.setDate(cur.getDate() + 1);
                    }
                }
            }
        }
        
        let cur = new Date(s1);
        const conflicts = [];
        const sessionTimes = SESSIONS[state.groups.find(x=>x.name===proposedGroupName).code];
        const allowedWeekdays = sessionTimes.days;

        while(cur <= e1){
            const wd = cur.getDay();
            if(allowedWeekdays.includes(wd) && !isHoliday(cur)){
                const dateStr = formatDateDMY(cur);
                const currentLoad = teacherDailyLoad[dateStr] || 0;
                
                if(currentLoad >= 2) { 
                    let conflictGroups = [];
                    for (const g of state.groups) {
                        if (g.archived) continue;
                        if (!g.assignments && !g.taAssignments) continue;
                        const gSched = computeScheduleForGroup(g);
                        for (const m of MODULES) {
                            let isAssigned = false;
                            if(g.assignments && g.assignments[m] === teacherName) isAssigned = true;
                            if(g.taAssignments && g.taAssignments[m] === teacherName) isAssigned = true;
                            
                            if (isAssigned) {
                                const sched = gSched.find(x => x.module === m);
                                if (sched) {
                                    const sDate = parseDateDMY(sched.start);
                                    const eDate = parseDateDMY(sched.end);
                                    if (cur >= sDate && cur <= eDate) {
                                        conflictGroups.push({name: g.name, times: sched.sessionTime});
                                    }
                                }
                            }
                        }
                    }

                    const conflictInfo = conflictGroups.map(cg => `${cg.name} (${cg.times})`).join(', ');
                    conflicts.push({date: dateStr, details: conflictInfo});
                }
            }
            cur.setDate(cur.getDate() + 1);
        }
        
        if(conflicts.length > 0){
            const sampleConflict = conflicts[0];
            const conflictMessage = `M√º…ôllim **${teacherName}** bu t…ôyinatla b…ôzi g√ºnl…ôrd…ô 2-d…ôn artƒ±q d…ôrs…ô t…ôyin olunacaq (**M√º…ôllim yoruldu**).\n\nToqqu≈üma detallarƒ± (N√ºmun…ô ${sampleConflict.date} tarixind…ô):\n\n${teacherName} artƒ±q bu qruplarda m…ô≈üƒüuldur:\n${sampleConflict.details}\n\nT…ôklif olunan modulun saatƒ±: ${moduleSchedule.sessionTime}`;
            return { withinLimit: false, message: conflictMessage };
        }
        
        return { withinLimit: true };
    }

    function isTeacherAvailable(teacherName, moduleSchedule){
        const s1 = parseDateDMY(moduleSchedule.start);
        const e1 = parseDateDMY(moduleSchedule.end);
        const [t1StartStr, t1EndStr] = moduleSchedule.sessionTime.split('-');
        const t1Start = parseTime(t1StartStr);
        const t1End = parseTime(t1EndStr);
        const proposedGroupName = moduleSchedule.groupName;
        
        const proposedGroup = state.groups.find(x=>x.name===proposedGroupName);
        const g1Session = SESSIONS[proposedGroup ? proposedGroup.code : 'CS1']; 
        
        const conflicts = [];

        for(const g of state.groups){
            if (g.archived) continue;
            if(!g.assignments && !g.taAssignments) continue;
            const g2Session = SESSIONS[g.code];
            
            const gModules = g.moduleCount === 6 ? MODULES_6 : MODULES_5;
for(const m of gModules){
                let isAssigned = false;
                if(g.assignments && g.assignments[m] === teacherName) isAssigned = true;
                if(g.taAssignments && g.taAssignments[m] === teacherName) isAssigned = true;
                
                if(isAssigned){
                    const sched = computeScheduleForGroup(g).find(x=>x.module===m);
                    if(!sched) continue;
                    
                    if (g.name === proposedGroupName && m === moduleSchedule.module) continue; 

                    const s2 = parseDateDMY(sched.start);
                    const e2 = parseDateDMY(sched.end);
                    const [t2StartStr, t2EndStr] = sched.sessionTime.split('-');
                    const t2Start = parseTime(t2StartStr);
                    const t2End = parseTime(t2EndStr);
                    
                    const dateOverlap = !(e1 < s2 || s1 > e2);
                    const timeOverlap = !(t1End <= t2Start || t1Start >= t2End);
                    const weekdayOverlap = g1Session.days.some(day => g2Session.days.includes(day));

                    if(dateOverlap && timeOverlap && weekdayOverlap) {
                        conflicts.push({groupName: g.name, sessionTimes: `${t2StartStr}-${t2EndStr}`, moduleName: m});
                    }
                }
            }
        }
        
        if(conflicts.length > 0){
            const conflictDetails = conflicts.map(c => 
                `- Qrup: ${c.groupName}, Modul: ${c.moduleName}, Saat: ${c.sessionTimes}`
            ).join('\n');
            const message = `Bu m√º…ôllim h…ômin vaxt aralƒ±ƒüƒ±nda ba≈üqa d…ôrsd…ô m…ô≈üƒüul olacaq (**Qƒ±rmƒ±zƒ± X…ôb…ôrdarlƒ±q**).\n\nToqqu≈üma detallarƒ±:\n${conflictDetails}\n\nT…ôklif edil…ôn Modul Saatƒ±: ${moduleSchedule.sessionTime}`;
            return { available: false, message: message };
        }
        return { available: true };
    }
    
    function generateTeacherDashboardHTML() {
        if (state.teachers.length === 0) {
            return '<h3>M√º…ôlliml…ôr Tablosu</h3><p>Sistemd…ô he√ß bir m√º…ôllim qeyd…ô alƒ±nmayƒ±b.</p>';
        }

        const teacherLoad = {}; 
        state.groups.forEach(g => {
            if (g.archived) return;
            const schedule = computeScheduleForGroup(g);
            schedule.forEach(s => {
                if (s.teacher) {
                    if (!teacherLoad[s.teacher]) teacherLoad[s.teacher] = [];
                    teacherLoad[s.teacher].push({
                        groupName: s.groupName, moduleName: s.module, start: s.start, end: s.end,
                        sessionTime: s.sessionTime, daysUsed: s.daysUsed, daysOfWeek: SESSIONS[s.groupCode].days, 
                        groupCode: s.groupCode, role: 'M√º…ôllim'
                    });
                }
                if (s.ta) {
                    if (!teacherLoad[s.ta]) teacherLoad[s.ta] = [];
                    teacherLoad[s.ta].push({
                        groupName: s.groupName, moduleName: s.module, start: s.start, end: s.end,
                        sessionTime: s.sessionTime, daysUsed: s.daysUsed, daysOfWeek: SESSIONS[s.groupCode].days, 
                        groupCode: s.groupCode, role: 'TA'
                    });
                }
            });
        });
        
        const daysMap = {0:'Bazar', 1:'Bazar ert…ôsi', 2:'√á…ôr≈ü…ônb…ô ax≈üamƒ±', 3:'√á…ôr≈ü…ônb…ô', 4:'C√ºm…ô ax≈üamƒ±', 5:'C√ºm…ô', 6:'≈û…ônb…ô'};
        
        let html = `<h3>M√º…ôlliml…ôr Tablosu</h3><p class="small muted">H…ôr m√º…ôllimin hansƒ± qruplarda, hansƒ± tarixl…ôrd…ô v…ô hansƒ± saatlarda m…ô≈üƒüul olduƒüu c…ôdv…ôl.</p><div style="max-height: 70vh; overflow-y: auto;">`;

        for (const teacher of state.teachers) {
            html += `<h4 style="margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">${teacher.name} ${getRoleBadge(teacher.role || 'teacher')}</h4>`;
            
            const assignments = teacherLoad[teacher.name] || [];

            if (assignments.length === 0) {
                html += '<p class="muted small">He√ß bir qrupa t…ôyin edilm…ôyib.</p>';
                continue;
            }

            html += '<table><thead><tr><th>Modul</th><th>Qrup</th><th>Ba≈ülanƒüƒ±c</th><th>Biti≈ü</th><th>Saat Aralƒ±ƒüƒ±</th><th>H…ôft…ô G√ºnl…ôri</th><th>Rol</th></tr></thead><tbody>';
            
            assignments.forEach(a => {
                const dayNames = a.daysOfWeek.map(d => daysMap[d]).join(', ');
                html += `<tr><td>${a.moduleName}</td><td>${a.groupName} (${a.groupCode})</td><td>${a.start}</td><td>${a.end}</td><td>${a.sessionTime}</td><td>${dayNames}</td><td>${a.role}</td></tr>`;
            });

            html += '</tbody></table>';
        }
        
        html += '</div>';
        return html;
    }

    function generateGroupsTableHTML() {
        if (state.groups.filter(g => !g.archived).length === 0) {
            return '<h3>Qruplar Tablosu</h3><p>Sistemd…ô he√ß bir aktiv qrup yoxdur.</p>';
        }

        const activeGroups = state.groups.filter(g => !g.archived).sort((a, b) => {
            return parseDateDMY(a.startDate) - parseDateDMY(b.startDate);
        });

        let html = `<h3>Qruplar Tablosu</h3><p class="small muted">B√ºt√ºn qruplarƒ±n modul t…ôf…ôrr√ºatlarƒ± v…ô m√º…ôllim t…ôyinatlarƒ±.</p>`;
        html += `<button class="btn success" onclick="exportGroupsToExcel()" style="margin-bottom:15px;">Excel-…ô Export Et</button>`;
        html += '<div style="max-height: 70vh; overflow-y: auto;">';

        activeGroups.forEach(g => {
            const schedule = computeScheduleForGroup(g);
            html += `<h4 style="margin-top: 20px; border-bottom: 2px solid var(--blue); padding-bottom: 5px;">${g.name} (${g.code})</h4>`;
            html += `<p class="small"><strong>Ba≈ülanƒüƒ±c:</strong> ${g.startDate} | <strong>Seans:</strong> ${SESSIONS[g.code].startTime}-${SESSIONS[g.code].endTime}</p>`;
            
            html += '<table><thead><tr><th>Modul</th><th>Ba≈ülama</th><th>Biti≈ü</th><th>Saat Aralƒ±ƒüƒ±</th><th>Saat</th><th>G√ºnl…ôr</th><th>M√º…ôllim</th><th>TA</th></tr></thead><tbody>';
            
            schedule.forEach(s => {
                html += `<tr>
                    <td>${s.module}</td>
                    <td>${s.start}</td>
<td>${s.end}</td>
<td>${s.sessionTime}</td>
<td>${s.hours}</td>
<td>${s.daysUsed}</td>
<td>${s.teacher || '-'}</td>
<td>${s.ta || '-'}</td>
</tr>`;
});

 html += '</tbody></table>';
    });

    html += '</div>';
    return html;
}

function exportGroupsToExcel() {
    const activeGroups = state.groups.filter(g => !g.archived).sort((a, b) => {
        return parseDateDMY(a.startDate) - parseDateDMY(b.startDate);
    });

    if (activeGroups.length === 0) {
        alert('Export edil…ôc…ôk qrup yoxdur.');
        return;
    }

    const wb = XLSX.utils.book_new();

    activeGroups.forEach(g => {
        const schedule = computeScheduleForGroup(g);
        const wsData = [
            [`Qrup: ${g.name}`, `Kod: ${g.code}`, `Ba≈ülanƒüƒ±c: ${g.startDate}`, `Seans: ${SESSIONS[g.code].startTime}-${SESSIONS[g.code].endTime}`],
            [],
            ['Modul', 'Ba≈ülama', 'Biti≈ü', 'Saat Aralƒ±ƒüƒ±', 'Saat', 'G√ºnl…ôr', 'M√º…ôllim', 'TA']
        ];

        schedule.forEach(s => {
            wsData.push([
                s.module,
                s.start,
                s.end,
                s.sessionTime,
                s.hours,
                s.daysUsed,
                s.teacher || '-',
                s.ta || '-'
            ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const sheetName = g.name.replace(/[^\w\s]/gi, '').substring(0, 31);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });

    XLSX.writeFile(wb, `Qruplar_Cedveli_${formatDateDMY(new Date()).replace(/\//g, '-')}.xlsx`);
}

openDashboardBtn.onclick = () => {
    const dashboardHtml = generateTeacherDashboardHTML();
    const win = window.open("", "_blank", "width=1000,height=700,scrollbars=yes");
    win.document.write(`<html><head><title>M√º…ôlliml…ôr Tablosu</title><style>${document.querySelector('style').textContent}body { padding: 20px; background: #fff; }table { width: 100%; border-collapse: collapse; margin-top: 10px; }th, td { padding: 10px; border: 1px solid #f3f6f8; text-align: left; font-size: 14px; }th { background: #f9fafb; font-weight: 600; }h3, h4 { font-family: Inter; }</style></head><body>${dashboardHtml}</body></html>`);
    win.document.close();
}

openGroupsTableBtn.onclick = () => {
    const groupsTableHtml = generateGroupsTableHTML();
    const win = window.open("", "_blank", "width=1200,height=700,scrollbars=yes");
    
    // XLSX kitabxanasƒ±nƒ± popup p…ônc…ôr…ôy…ô …ôlav…ô edirik
    win.document.write(`
    <html>
    <head>
        <title>Qruplar Tablosu</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>
        <style>
            ${document.querySelector('style').textContent}
            body { padding: 20px; background: #fff; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { padding: 10px; border: 1px solid #f3f6f8; text-align: left; font-size: 14px; }
            th { background: #f9fafb; font-weight: 600; }
            h3, h4 { font-family: Inter; }
        </style>
    </head>
    <body>
        ${groupsTableHtml}
        <script>
            // State m…ôlumatlarƒ±nƒ± popup p…ônc…ôr…ôy…ô g√∂nd…ôririk
            const state = ${JSON.stringify(state)};
            const SESSIONS = ${JSON.stringify(SESSIONS)};
            
            // Lazƒ±mi funksiyalar
            function parseDateDMY(s) {
                const [d,m,y] = s.split('/').map(Number); 
                return new Date(y,m-1,d);
            }
            
            function formatDateDMY(date) {
                const d=('0'+date.getDate()).slice(-2); 
                const m=('0'+(date.getMonth()+1)).slice(-2); 
                const y=date.getFullYear(); 
                return d+'/'+m+'/'+y;
            }
            
            function isHoliday(date) {
                const dateStr = formatDateDMY(date); 
                if (!state.nonWorkingHolidays || state.nonWorkingHolidays.length === 0) return false; 
                return state.nonWorkingHolidays.includes(dateStr);
            }
            
            const MODULES_5 = ${JSON.stringify(MODULES_5)};
            const MODULES_6 = ${JSON.stringify(MODULES_6)};
		
            
            function computeScheduleForGroup(group) {
                const session = SESSIONS[group.code];
                const dailyHours = session.hoursPerDay;
                const allowedWeekdays = session.days;
                const result = [];
                let curDate = parseDateDMY(group.startDate);
                
                function advanceToAllowed(date) {
                    let d = new Date(date);
                    while(true) {
                        const wd = d.getDay();
                        if(allowedWeekdays.includes(wd) && !isHoliday(d)) return d;
                        d.setDate(d.getDate()+1);
                    }
                }
                curDate = advanceToAllowed(curDate);
                
                const modulesToUse = group.moduleCount === 6 ? MODULES_6 : MODULES_5;
                
                for(const module of modulesToUse) {
                    const hours = Number(group.moduleHours[module]||40);
                    const daysNeeded = Math.ceil(hours / dailyHours);
                    const start = new Date(curDate);
                    let usedDays=0;
                    let lastDay = new Date(start);
                    
                    while(usedDays < daysNeeded) {
                        const wd = curDate.getDay();
                        if(allowedWeekdays.includes(wd) && !isHoliday(curDate)) {
                            lastDay = new Date(curDate);
                            usedDays++;
                        }
                        curDate.setDate(curDate.getDate()+1);
                    }
                    curDate = advanceToAllowed(curDate);
                    
                    result.push({
                        module, 
                        start: formatDateDMY(start), 
                        end: formatDateDMY(lastDay), 
                        hours, 
                        daysUsed: daysNeeded, 
                        teacher: (group.assignments && group.assignments[module]) || null,
                        ta: (group.taAssignments && group.taAssignments[module]) || null,
                        sessionTime: session.startTime + '-' + session.endTime, 
                        groupName: group.name, 
                        groupCode: group.code
                    });
                }
                return result;
            }
            
            // Export funksiyasƒ±
            function exportGroupsToExcel() {
                const activeGroups = state.groups.filter(g => !g.archived).sort((a, b) => {
                    return parseDateDMY(a.startDate) - parseDateDMY(b.startDate);
                });

                if (activeGroups.length === 0) {
                    alert('Export edil…ôc…ôk qrup yoxdur.');
                    return;
                }

                const wb = XLSX.utils.book_new();

                activeGroups.forEach(g => {
                    const schedule = computeScheduleForGroup(g);
                    const wsData = [
                        ['Qrup: ' + g.name, 'Kod: ' + g.code, 'Ba≈ülanƒüƒ±c: ' + g.startDate, 'Seans: ' + SESSIONS[g.code].startTime + '-' + SESSIONS[g.code].endTime],
                        [],
                        ['Modul', 'Ba≈ülama', 'Biti≈ü', 'Saat Aralƒ±ƒüƒ±', 'Saat', 'G√ºnl…ôr', 'M√º…ôllim', 'TA']
                    ];

                    schedule.forEach(s => {
                        wsData.push([
                            s.module,
                            s.start,
                            s.end,
                            s.sessionTime,
                            s.hours,
                            s.daysUsed,
                            s.teacher || '-',
                            s.ta || '-'
                        ]);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    const sheetName = g.name.replace(/[^\\w\\s]/gi, '').substring(0, 31);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                XLSX.writeFile(wb, 'Qruplar_Cedveli_' + formatDateDMY(new Date()).replace(/\\//g, '-') + '.xlsx');
            }
        <\/script>
    </body>
    </html>
    `);
    
    win.document.close();
}

openGradingBtn.onclick = () => {
    openGradingModal();
}

function openGradingModal() {
    const modal = document.getElementById('gradingModal');
    const content = document.getElementById('gradingContent');

    const activeGroups = state.groups.filter(g => !g.archived);

    if (activeGroups.length === 0) {
        content.innerHTML = '<p class="muted">Aktiv qrup yoxdur. ∆èvv…ôlc…ô qrup …ôlav…ô edin.</p>';
        modal.classList.add('active');
        return;
    }

    let html = '<h4>Qrup Se√ßin</h4>';
    html += '<select id="gradingGroupSelect" style="margin-bottom:15px;"><option value="">-- Qrup se√ßin --</option>';
    activeGroups.forEach((g, idx) => {
        const realIdx = state.groups.indexOf(g);
        html += `<option value="${realIdx}">${g.name}</option>`;
    });
    html += '</select>';
    html += '<div id="gradingGroupContent"></div>';

    content.innerHTML = html;
    
    document.getElementById('gradingGroupSelect').onchange = (e) => {
        const groupIdx = e.target.value;
        if (groupIdx === '') {
            document.getElementById('gradingGroupContent').innerHTML = '';
            return;
        }
        renderGradingForGroup(Number(groupIdx));
    };

    modal.classList.add('active');
}

function closeGradingModal() {
    document.getElementById('gradingModal').classList.remove('active');
}

function renderGradingForGroup(groupIdx) {
    const g = state.groups[groupIdx];
    const container = document.getElementById('gradingGroupContent');

    if (!state.grading) state.grading = {};
    if (!state.grading[g.name]) state.grading[g.name] = { students: [], assessments: [] };

    const groupGrading = state.grading[g.name];

    let html = `<h4>${g.name} - Qiym…ôtl…ôndirm…ô</h4>`;
    
    html += '<div style="margin-top:15px;"><h5>T…ôl…ôb…ôl…ôr</h5>';
    html += '<div style="display:flex;gap:8px;margin-bottom:10px;">';
    html += '<input id="newStudentName" placeholder="T…ôl…ôb…ô adƒ±" style="flex:1;" />';
    html += '<button class="btn" onclick="addStudent(' + groupIdx + ')">T…ôl…ôb…ô ∆èlav…ô Et</button>';
    html += '</div>';

    if (groupGrading.students.length === 0) {
        html += '<p class="muted small">T…ôl…ôb…ô …ôlav…ô edilm…ôyib.</p>';
    } else {
        html += '<table><thead><tr><th>Ad</th><th>∆èm…ôliyyat</th></tr></thead><tbody>';
        groupGrading.students.forEach((student, idx) => {
            html += `<tr><td>${student}</td><td><button class="btn danger" style="padding:4px 8px;font-size:11px;" onclick="deleteStudent(${groupIdx}, ${idx})">Sil</button></td></tr>`;
        });
        html += '</tbody></table>';
    }
    html += '</div>';

    html += '<div style="margin-top:20px;"><h5>Qiym…ôtl…ôndirm…ô B√∂lm…ôl…ôri</h5>';
    html += '<div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">';
    html += '<input id="newAssessmentName" placeholder="B√∂lm…ô adƒ± (m…ôs: Quiz 1)" style="flex:1;min-width:150px;" />';
    html += '<input id="newAssessmentDate" placeholder="Tarix (g√ºn/ay/il)" style="width:120px;" />';
    html += '<button class="btn" onclick="addAssessment(' + groupIdx + ')">B√∂lm…ô ∆èlav…ô Et</button>';
    html += '</div>';

    if (groupGrading.assessments.length === 0) {
        html += '<p class="muted small">Qiym…ôtl…ôndirm…ô b√∂lm…ôsi …ôlav…ô edilm…ôyib.</p>';
    } else {
        html += '<table><thead><tr><th>Ad</th><th>Tarix</th><th>∆èm…ôliyyat</th></tr></thead><tbody>';
        groupGrading.assessments.forEach((assessment, idx) => {
            html += `<tr><td>${assessment.name}</td><td>${assessment.date || '-'}</td><td><button class="btn danger" style="padding:4px 8px;font-size:11px;" onclick="deleteAssessment(${groupIdx}, ${idx})">Sil</button></td></tr>`;
        });
        html += '</tbody></table>';
    }
    html += '</div>';

    if (groupGrading.students.length > 0 && groupGrading.assessments.length > 0) {
        html += '<div style="margin-top:20px;"><h5>Qiym…ôtl…ôr C…ôdv…ôli</h5>';
        html += '<div style="overflow-x:auto;"><table><thead><tr><th>T…ôl…ôb…ô</th>';
        groupGrading.assessments.forEach(a => {
            html += `<th>${a.name}</th>`;
        });
        html += '</tr></thead><tbody>';

        groupGrading.students.forEach((student, sIdx) => {
            html += `<tr><td><strong>${student}</strong></td>`;
            groupGrading.assessments.forEach((assessment, aIdx) => {
                const grade = assessment.grades && assessment.grades[student] ? assessment.grades[student] : '';
                html += `<td><input type="text" value="${grade}" style="width:80px;padding:4px;" onchange="updateGrade(${groupIdx}, ${aIdx}, '${student}', this.value)" /></td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        html += '<button class="btn" style="margin-top:10px;" onclick="saveGrading()">Qiym…ôtl…ôri Saxla</button>';
        html += '</div>';
    }

    container.innerHTML = html;
}

function addStudent(groupIdx) {
    const input = document.getElementById('newStudentName');
    const name = input.value.trim();
    if (!name) {
        alert('T…ôl…ôb…ô adƒ± daxil edin!');
        return;
    }

    const g = state.groups[groupIdx];
    if (!state.grading[g.name]) state.grading[g.name] = { students: [], assessments: [] };
    
    if (state.grading[g.name].students.includes(name)) {
        alert('Bu t…ôl…ôb…ô artƒ±q …ôlav…ô edilib!');
        return;
    }

    state.grading[g.name].students.push(name);
    input.value = '';
    saveState();
    renderGradingForGroup(groupIdx);
}

function deleteStudent(groupIdx, studentIdx) {
    if (!confirm('Bu t…ôl…ôb…ôni silm…ôk ist…ôdiyinizd…ôn …ôminsiniz?')) return;
    const g = state.groups[groupIdx];
    state.grading[g.name].students.splice(studentIdx, 1);
    saveState();
    renderGradingForGroup(groupIdx);
}

function addAssessment(groupIdx) {
    const nameInput = document.getElementById('newAssessmentName');
    const dateInput = document.getElementById('newAssessmentDate');
    
    const name = nameInput.value.trim();
    const date = dateInput.value.trim();

    if (!name) {
        alert('B√∂lm…ô adƒ± daxil edin!');
        return;
    }

    const g = state.groups[groupIdx];
    if (!state.grading[g.name]) state.grading[g.name] = { students: [], assessments: [] };

    state.grading[g.name].assessments.push({ name, date, grades: {} });
    nameInput.value = '';
    dateInput.value = '';
    saveState();
    renderGradingForGroup(groupIdx);
}

function deleteAssessment(groupIdx, assessmentIdx) {
    if (!confirm('Bu qiym…ôtl…ôndirm…ô b√∂lm…ôsini silm…ôk ist…ôdiyinizd…ôn …ôminsiniz?')) return;
    const g = state.groups[groupIdx];
    state.grading[g.name].assessments.splice(assessmentIdx, 1);
    saveState();
    renderGradingForGroup(groupIdx);
}

function updateGrade(groupIdx, assessmentIdx, studentName, grade) {
    const g = state.groups[groupIdx];
    if (!state.grading[g.name].assessments[assessmentIdx].grades) {
        state.grading[g.name].assessments[assessmentIdx].grades = {};
    }
    state.grading[g.name].assessments[assessmentIdx].grades[studentName] = grade;
}

function saveGrading() {
    saveState();
    alert('Qiym…ôtl…ôr saxlanƒ±ldƒ±!');
}

function openGroupDetailsPopup(idx) {
    const win = window.open("", "_blank", "width=800,height=750,scrollbars=yes");
    win.name = "GroupDetailsPopup"; 
    win.document.write(`<html><head><title>Qrup T…ôf…ôrr√ºatlarƒ±: ${state.groups[idx].name}</title><style>${document.querySelector('style').textContent}body { padding: 20px; background: #f7fafc; }.group-details-container { border: none; padding: 0; max-height: none; overflow-y: visible; }.btn { cursor: pointer; }</style></head><body><div id="popupContent" class="group-details-container">Y√ºkl…ônir...</div></body></html>`);
    win.document.close();
    const popupContentDiv = win.document.getElementById('popupContent');
    win.renderContent = () => { renderGroupDetails(idx, popupContentDiv); };
    win.renderContent();
}

addTeacherBtn.onclick = ()=>{
  const name = teacherNameInput.value.trim(); 
  if(!name) return alert('Ad daxil edin');
  if(state.teachers.some(t => t.name === name)) return alert('Bu m√º…ôllim artƒ±q m√∂vcuddur!');
  
  const role = teacherRoleInput.value;
  state.teachers.push({name, role}); 
  teacherNameInput.value=''; 
  saveState();
}

addGroupBtn.onclick = ()=>{
  const name = groupNameInput.value.trim(); 
  if(!name) return alert('Qrup adƒ± daxil edin');
  const code = groupCodeInput.value;
  const start = startDateInput.value.trim(); 
  if(!/^\d{2}\/\d{2}\/\d{4}$/.test(start)) return alert('Tarix formatƒ± dd/mm/yyyy olmalƒ±dƒ±r');
  
  const moduleHours = {};
  document.querySelectorAll('[data-module]').forEach(inp=> moduleHours[inp.dataset.module] = Number(inp.value||40));

 const moduleCount = Number(document.getElementById('moduleCount').value);

  const existingIndex = state.groups.findIndex(g=>g.name===name);
  const groupObj = {
    name, 
    code, 
    startDate:start,
    moduleCount: moduleCount,
    moduleHours, 
    assignments: (existingIndex!==-1? state.groups[existingIndex].assignments : {}),
    taAssignments: (existingIndex!==-1? state.groups[existingIndex].taAssignments : {}),
    weeklyNotes: (existingIndex!==-1? state.groups[existingIndex].weeklyNotes:{}),
    archived: false
  };
  
  if(existingIndex===-1) state.groups.push(groupObj); 
  else state.groups[existingIndex]=groupObj;
  
  saveState();
  alert('Qrup yaradƒ±ldƒ± / yenil…ôndi');
}

clearBtn.onclick = ()=>{ 
  groupNameInput.value=''; 
  startDateInput.value=''; 
  updateModuleHours(groupCodeInput.value); 
}

groupsList.onclick = (e)=>{
  const btn = e.target.closest('button'); 
  if(!btn) return;
  
  if(btn.classList.contains('normal-open-btn')){ 
      renderGroupDetails(Number(btn.dataset.idx), groupDetails); 
  }
  else if(btn.classList.contains('popup-open-btn')){
      openGroupDetailsPopup(Number(btn.dataset.idx));
  }
  else if(btn.dataset.archive){ 
      const idx = Number(btn.dataset.archive);
      if(confirm('Qrupu arxivl…ôm…ôk ist…ôdiyinizd…ôn …ôminsiniz?')){ 
          state.groups[idx].archived = true;
          saveState();
          groupDetails.innerHTML='Se√ßim edilm…ôyib'; 
      } 
  }
  else if(btn.dataset.del){ 
      if(confirm('Qrup silinsin?')){ 
          state.groups.splice(Number(btn.dataset.del),1); 
          saveState();
          groupDetails.innerHTML='Se√ßim edilm…ôyib'; 
      } 
  }
}

archivedGroupsList.onclick = (e)=>{
  const btn = e.target.closest('button'); 
  if(!btn) return;
  
  if(btn.classList.contains('normal-open-btn')){ 
      renderGroupDetails(Number(btn.dataset.idx), groupDetails); 
  }
  else if(btn.dataset.restore){ 
      const idx = Number(btn.dataset.restore);
      if(confirm('Qrupu geri qaytarmaq ist…ôdiyinizd…ôn …ôminsiniz?')){ 
          state.groups[idx].archived = false;
          saveState();
          groupDetails.innerHTML='Se√ßim edilm…ôyib'; 
      } 
  }
  else if(btn.dataset.del){ 
      if(confirm('Qrup tam silinsin?')){ 
          state.groups.splice(Number(btn.dataset.del),1); 
          saveState();
          groupDetails.innerHTML='Se√ßim edilm…ôyib'; 
      } 
  }
}

function startFirebaseListener() {
    db.collection('scheduler_data').doc(GLOBAL_DOC_ID)
        .onSnapshot(doc => {
            if (doc.exists) {
                const newData = doc.data();
                const isInitialLoad = state.groups.length === 0 && newData.groups && newData.groups.length > 0;

                state = newData;
                
                if(!state.nonWorkingHolidays || state.nonWorkingHolidays.length === 0) { 
                    state.nonWorkingHolidays = HOLIDAYS_RAW.map(h => h.date); 
                    saveState(); 
                }
                
                if(!state.customHolidays) state.customHolidays = [];
                if(!state.archivedGroups) state.archivedGroups = [];
                if(!state.grading) state.grading = {};
				if(!state.calendarNotes) state.calendarNotes = {};
				if(!state.dayAssignments) state.dayAssignments = {};
                
                renderTeachers(); 
                renderGroups(); 
                renderHolidays();
                updateModuleHours(groupCodeInput.value); 

                if (state.groups.length === 0 && !isInitialLoad) {
                    state.groups.push({name:'CS1-A', code:'CS1', startDate:'06/10/2025', moduleHours: DEFAULT_MODULE_HOURS['CS1/CS2'], assignments:{}, taAssignments:{}, weeklyNotes:{}, archived:false});
                    state.groups.push({name:'CS3-Y', code:'CS3', startDate:'06/10/2025', moduleHours: DEFAULT_MODULE_HOURS['CS3'], assignments:{}, taAssignments:{}, weeklyNotes:{}, archived:false});
                    state.groups.push({name:'CS4-H', code:'CS4', startDate:'04/10/2025', moduleHours: DEFAULT_MODULE_HOURS['CS4/CS5'], assignments:{}, taAssignments:{}, weeklyNotes:{}, archived:false});
                    saveState();
                }
                
            } else {
                state.nonWorkingHolidays = HOLIDAYS_RAW.map(h => h.date); 
                state.groups = [];
                state.teachers = [];
                state.customHolidays = [];
                state.archivedGroups = [];
                state.grading = {};
                saveState();
            }
        }, error => {
            console.error("Firebase Snapshot Error: ", error);
            alert("M…ôlumat dinl…ôm…ôsi zamanƒ± x…ôta yarandƒ±.");
        });
}

// B√ºt√ºn Qeydl…ôr funksiyalarƒ±
const openAllNotesBtn = document.getElementById('openAllNotesBtn');
openAllNotesBtn.onclick = () => openAllNotesModal();

const exportAllDataBtn = document.getElementById('exportAllDataBtn');
exportAllDataBtn.onclick = () => exportAllDataToExcel();

function exportAllDataToExcel() {
  const wb = XLSX.utils.book_new();
  
  // 1. Qruplar
  const groupsData = [['Qrup Adƒ±', 'Kod', 'Ba≈ülanƒüƒ±c', 'Modul Sayƒ±', 'Status']];
  state.groups.forEach(g => {
    groupsData.push([
      g.name,
      g.code,
      g.startDate,
      g.moduleCount || 5,
      g.archived ? 'Arxiv' : 'Aktiv'
    ]);
  });
  const wsGroups = XLSX.utils.aoa_to_sheet(groupsData);
  XLSX.utils.book_append_sheet(wb, wsGroups, 'Qruplar');
  
  // 2. M√º…ôlliml…ôr
  const teachersData = [['Ad Soyad', 'Rol', 'Email', 'Telefon', 'Qeyd']];
  state.teachers.forEach(t => {
    teachersData.push([
      t.name,
      t.role === 'teacher' ? 'M√º…ôllim' : t.role === 'ta' ? 'TA' : 'M√º…ôllim/TA',
      t.email || '',
      t.phone || '',
      t.note || ''
    ]);
  });
  const wsTeachers = XLSX.utils.aoa_to_sheet(teachersData);
  XLSX.utils.book_append_sheet(wb, wsTeachers, 'M√º…ôlliml…ôr');
  
  // 3. H…ôr qrup √º√ß√ºn modul c…ôdv…ôli
  state.groups.filter(g => !g.archived).forEach(g => {
    const schedule = computeScheduleForGroup(g);
    const scheduleData = [
      [g.name + ' - Modul C…ôdv…ôli'],
      [],
      ['Modul', 'Ba≈ülama', 'Biti≈ü', 'Saat', 'G√ºnl…ôr', 'M√º…ôllim', 'TA']
    ];
    
    schedule.forEach(s => {
      scheduleData.push([
        s.module,
        s.start,
        s.end,
        s.hours,
        s.daysUsed,
        s.teacher || '-',
        s.ta || '-'
      ]);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(scheduleData);
    const sheetName = g.name.replace(/[^\w\s]/gi, '').substring(0, 31);
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
  });
  
  // 4. Haftalƒ±k Qeydl…ôr
  const notesData = [['Qrup', 'Tarix', 'Status', 'Qeyd']];
  state.groups.forEach(g => {
    const notes = g.weeklyNotes || {};
    Object.keys(notes).forEach(date => {
      const statusText = notes[date].status === 'green' ? 'H…ôll olundu' :
                        notes[date].status === 'orange' ? 'Bu h…ôft…ô H∆èLL' : 'G…ôl…ôn h…ôft…ô';
      notesData.push([
        g.name,
        date,
        statusText,
        notes[date].text || ''
      ]);
    });
  });
  const wsNotes = XLSX.utils.aoa_to_sheet(notesData);
  XLSX.utils.book_append_sheet(wb, wsNotes, 'H…ôft…ôlik Qeydl…ôr');
  // 5. T…ôqvim G√ºn T…ôyinatlarƒ± (dayAssignments)
  if (state.dayAssignments && Object.keys(state.dayAssignments).length > 0) {
    const dayAssignData = [['Qrup', 'Tarix', 'M√º…ôllim', 'TA']];
    
    Object.keys(state.dayAssignments).forEach(key => {
      const assignment = state.dayAssignments[key];
      dayAssignData.push([
        assignment.groupName,
        assignment.date,
        assignment.teacher || '',
        assignment.ta || ''
      ]);
    });
    
    const wsDayAssign = XLSX.utils.aoa_to_sheet(dayAssignData);
    XLSX.utils.book_append_sheet(wb, wsDayAssign, 'G√ºn T…ôyinatlarƒ±');
  }
  // 5. T…ôqvim G√ºn T…ôyinatlarƒ±
if (state.dayAssignments && Object.keys(state.dayAssignments).length > 0) {
  const dayAssignData = [['Qrup', 'Tarix', 'M√º…ôllim', 'TA']];
  
  Object.keys(state.dayAssignments).forEach(key => {
    const assignment = state.dayAssignments[key];
    dayAssignData.push([
      assignment.groupName,
      assignment.date,
      assignment.teacher || '',
      assignment.ta || ''
    ]);
  });
  
  const wsDayAssign = XLSX.utils.aoa_to_sheet(dayAssignData);
  XLSX.utils.book_append_sheet(wb, wsDayAssign, 'G√ºn T…ôyinatlarƒ±');
}
  // 5. Bayramlar
  const holidaysData = [['Tarix', 'Bayram Adƒ±', 'Se√ßilib']];
  const allHolidays = getAllHolidays();
  allHolidays.forEach(h => {
    holidaysData.push([
      h.date,
      h.name,
      state.nonWorkingHolidays.includes(h.date) ? 'B…ôli' : 'Xeyr'
    ]);
  });
  const wsHolidays = XLSX.utils.aoa_to_sheet(holidaysData);
  XLSX.utils.book_append_sheet(wb, wsHolidays, 'Bayramlar');
  
  // 6. Qiym…ôtl…ôndirm…ô (…ôg…ôr varsa)
  if (state.grading && Object.keys(state.grading).length > 0) {
    Object.keys(state.grading).forEach(groupName => {
      const grading = state.grading[groupName];
      if (grading.students && grading.students.length > 0) {
        const gradingData = [[groupName + ' - Qiym…ôtl…ôndirm…ô'], []];
        
        // Header
        const header = ['T…ôl…ôb…ô'];
        if (grading.assessments) {
          grading.assessments.forEach(a => header.push(a.name));
        }
        gradingData.push(header);
        
        // T…ôl…ôb…ôl…ôr
        grading.students.forEach(student => {
          const row = [student];
          if (grading.assessments) {
            grading.assessments.forEach(a => {
              row.push(a.grades && a.grades[student] ? a.grades[student] : '');
            });
          }
          gradingData.push(row);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(gradingData);
        const sheetName = (groupName + ' Qiymet').replace(/[^\w\s]/gi, '').substring(0, 31);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
      }
    });
  }
  
  // Excel'i y√ºkl…ô
  const today = new Date();
  const filename = `IT_Tedris_Backup_${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}.xlsx`;
  XLSX.writeFile(wb, filename);
  
  alert('‚úÖ B√ºt√ºn datalar uƒüurla Excel faylƒ±na export edildi!');
}

function openAllNotesModal() {
    const modal = document.getElementById('allNotesModal');
    const content = document.getElementById('allNotesContent');
    
    const activeGroups = state.groups.filter(g => !g.archived);
    
    if (activeGroups.length === 0) {
        content.innerHTML = '<p class="muted">Aktiv qrup yoxdur.</p>';
        // ƒ∞ndiki tarix…ô yaxƒ±n qeydi tap v…ô scroll et
setTimeout(() => {
  const today = new Date();
  today.setHours(0,0,0,0);
  
  let closestDate = null;
  let closestDiff = Infinity;
  
  sortedDates.forEach(dateStr => {
    const noteDate = parseDateDMY(dateStr);
    const diff = Math.abs(noteDate - today);
    if (diff < closestDiff) {
      closestDiff = diff;
      closestDate = dateStr;
    }
  });
  
  if (closestDate) {
    const targetCell = content.querySelector(`[data-date="${closestDate}"]`);
    if (targetCell) {
      targetCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
}, 300);
		modal.classList.add('active');
        return;
    }

    // B√ºt√ºn tarixl…ôri topla
    const allDates = new Set();
    activeGroups.forEach(g => {
        const schedule = computeScheduleForGroup(g);
        if (schedule.length > 0) {
            const progStart = parseDateDMY(g.startDate);
            const progEnd = parseDateDMY(schedule[schedule.length-1].end);
            
            let cur = new Date(progStart);
            while(cur.getDay() !== 2) cur.setDate(cur.getDate() + 1);
            
            while(cur <= progEnd) {
                if(cur >= progStart) allDates.add(formatDateDMY(cur));
                cur.setDate(cur.getDate() + 7);
            }
        }
    });
    
    const sortedDates = Array.from(allDates).sort((a, b) => {
        return parseDateDMY(a) - parseDateDMY(b);
    });

    if (sortedDates.length === 0) {
        content.innerHTML = '<p class="muted">Qeyd tarixi tapƒ±lmadƒ±.</p>';
        modal.classList.add('active');
        return;
    }

    // C…ôdv…ôl yarat
    let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr><th style="position:sticky;left:0;background:#f9fafb;z-index:10;min-width:150px;">Qrup</th>';
    
    sortedDates.forEach((date, idx) => {
        html += `<th style="min-width:200px;"><div style="font-size:12px;font-weight:normal;color:var(--muted);">H…ôft…ô ${idx+1}</div>${date}</th>`;
    });
    
    html += '</tr></thead><tbody>';
    
    // H…ôr qrup √º√ß√ºn s…ôtir
    activeGroups.forEach(g => {
        html += `<tr><td style="position:sticky;left:0;background:#fff;z-index:5;font-weight:600;">${g.name}</td>`;
        
        const notes = g.weeklyNotes || {};
        
        sortedDates.forEach(date => {
            const entry = notes[date] || {status:'yellow', text:''};
            const statusColor = entry.status === 'green' ? 'var(--green)' : 
                              entry.status === 'orange' ? 'var(--orange)' : 'var(--yellow)';
            const statusIcon = entry.status === 'green' ? '‚úì' : 
                             entry.status === 'orange' ? '‚ö†Ô∏è' : '‚è≥';
            
            html += `<td style="padding:8px;border:1px solid #f0f5f9;vertical-align:top;">
                <div style="display:flex;flex-direction:column;gap:6px;">
                    <select data-group="${g.name}" data-date="${date}" class="note-status-select select-status-${entry.status}" style="font-size:11px;">
                        <option value="green" ${entry.status==='green'?'selected':''}>‚úì H…ôll olundu</option>
                        <option value="yellow" ${entry.status==='yellow'?'selected':''}>‚è≥ G…ôl…ôn h…ôft…ô</option>
                        <option value="orange" ${entry.status==='orange'?'selected':''}>‚ö†Ô∏è Bu h…ôft…ô H∆èLL</option>
                    </select>
                    <textarea data-group="${g.name}" data-date="${date}" class="note-text-input" 
                        placeholder="Qeyd..." rows="2" 
                        style="font-size:11px;resize:vertical;min-height:50px;">${entry.text||''}</textarea>
                </div>
            </td>`;
        });
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    html += '<div style="margin-top:15px;text-align:center;position:sticky;left:0;">';
    html += '<button class="btn" onclick="saveAllNotes()">üíæ B√ºt√ºn D…ôyi≈üiklikl…ôri Saxla</button>';
    html += '</div>';
    
    content.innerHTML = html;
    
    // Status d…ôyi≈ü…ônd…ô r…ông d…ôyi≈üsin
    content.querySelectorAll('.note-status-select').forEach(sel => {
        sel.onchange = function() {
            this.className = 'note-status-select select-status-' + this.value;
        };
    });
    
    modal.classList.add('active');
}

function closeAllNotesModal() {
    document.getElementById('allNotesModal').classList.remove('active');
}

function saveAllNotes() {
    const content = document.getElementById('allNotesContent');
    
    content.querySelectorAll('.note-status-select').forEach(sel => {
        const groupName = sel.dataset.group;
        const date = sel.dataset.date;
        const status = sel.value;
        const textArea = content.querySelector(`.note-text-input[data-group="${groupName}"][data-date="${date}"]`);
        const text = textArea ? textArea.value : '';
        
        const group = state.groups.find(g => g.name === groupName);
        if (group) {
            if (!group.weeklyNotes) group.weeklyNotes = {};
            group.weeklyNotes[date] = {status, text};
        }
    });
    
    saveState();
    alert('B√ºt√ºn qeydl…ôr saxlanƒ±ldƒ±! ‚úì');
}

// üìÖ ƒ∞ndiki tarix…ô …ôn yaxƒ±n qeydi tap v…ô ora scroll et
function scrollToClosestDate() {
    const content = document.getElementById('allNotesContent');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // B√ºt√ºn tarixl…ôri topla
    const allDateCells = content.querySelectorAll('th');
    let closestDate = null;
    let closestDiff = Infinity;
    
    allDateCells.forEach(cell => {
        const dateText = cell.textContent.trim();
        // Tarix formatƒ±nƒ± yoxla (dd/mm/yyyy)
        const dateMatch = dateText.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        
        if (dateMatch) {
            const dateStr = dateMatch[0];
            const noteDate = parseDateDMY(dateStr);
            const diff = Math.abs(noteDate - today);
            
            if (diff < closestDiff) {
                closestDiff = diff;
                closestDate = cell;
            }
        }
    });
    
    if (closestDate) {
        closestDate.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // ∆èn yaxƒ±n tarixi vurƒüula (3 saniy…ô)
        closestDate.style.background = '#fbbf24';
        closestDate.style.transition = 'background 0.5s';
        setTimeout(() => {
            closestDate.style.background = '';
        }, 3000);
        
        alert('‚úÖ ƒ∞ndiki tarix…ô …ôn yaxƒ±n qeyd: ' + closestDate.textContent.match(/\d{2}\/\d{2}\/\d{4}/)[0]);
    } else {
        alert('‚ùå Tarix tapƒ±lmadƒ±!');
    }
}


// ============== T∆èQVƒ∞M Sƒ∞STEMƒ∞ ==============

const openCalendarBtn = document.getElementById('openCalendarBtn');
openCalendarBtn.onclick = () => openCalendarModal();

const MONTHS_AZ = ['Yanvar', 'Fevral', 'Mart', 'Aprel', 'May', 'ƒ∞yun', 
                   'ƒ∞yul', 'Avqust', 'Sentyabr', 'Oktyabr', 'Noyabr', 'Dekabr'];
const DAYS_AZ = ['B', 'Be', '√áa', '√á', 'Ca', 'C', '≈û'];

function openCalendarModal() {
  const modal = document.getElementById('calendarModal');
  
  // ƒ∞ll…ôri doldur
  const yearSelect = document.getElementById('calendarYear');
  yearSelect.innerHTML = '';
  for(let y = 2025; y <= 2030; y++) {
    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
  }
  yearSelect.value = new Date().getFullYear();
  
  // Aylarƒ± doldur
  const monthSelect = document.getElementById('calendarMonth');
  monthSelect.innerHTML = '';
  MONTHS_AZ.forEach((m, i) => {
    monthSelect.innerHTML += `<option value="${i}">${m}</option>`;
  });
  monthSelect.value = new Date().getMonth();
  
  // Qrup filtrini doldur
  const filterSelect = document.getElementById('calendarFilter');
  filterSelect.innerHTML = '<option value="all">B√ºt√ºn Qruplar</option>';
  state.groups.filter(g => !g.archived).forEach(g => {
    filterSelect.innerHTML += `<option value="${g.name}">${g.name}</option>`;
  });
  
  // M√º…ôllim filtrini doldur
  const teacherFilter = document.getElementById('calendarTeacherFilter');
  teacherFilter.innerHTML = '<option value="all">B√ºt√ºn M√º…ôlliml…ôr</option>';
  state.teachers.forEach(t => {
    teacherFilter.innerHTML += `<option value="${t.name}">${t.name}</option>`;
  });
  
  // Event listener'l…ôr
  document.getElementById('calendarViewType').onchange = renderCalendar;
  document.getElementById('calendarYear').onchange = renderCalendar;
  document.getElementById('calendarMonth').onchange = renderCalendar;
  document.getElementById('calendarFilter').onchange = renderCalendar;
  document.getElementById('calendarTeacherFilter').onchange = renderCalendar;
  
  modal.classList.add('active');
  renderCalendar();
}

function closeCalendarModal() {
  document.getElementById('calendarModal').classList.remove('active');
}

function closeCalendarDayModal() {
  document.getElementById('calendarDayModal').classList.remove('active');
}

function renderCalendar() {
  const viewType = document.getElementById('calendarViewType').value;
  const year = Number(document.getElementById('calendarYear').value);
  const month = Number(document.getElementById('calendarMonth').value);
  const filter = document.getElementById('calendarFilter').value;
  const teacherFilter = document.getElementById('calendarTeacherFilter').value;
  
  const monthSelect = document.getElementById('calendarMonth');
  monthSelect.style.display = viewType === 'month' ? 'block' : 'none';
  
  const container = document.getElementById('calendarContent');
  
  if(viewType === 'year') {
    container.innerHTML = renderYearView(year, filter, teacherFilter);
  } else {
    container.innerHTML = renderMonthView(year, month, filter, teacherFilter);
  }
}

function renderYearView(year, groupFilter, teacherFilter) {
  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;">';
  
  for(let m = 0; m < 12; m++) {
    html += `<div style="border:1px solid #e6edf3;border-radius:8px;padding:10px;background:#fff;">
      <h4 style="margin:0 0 10px 0;text-align:center;color:var(--blue);">${MONTHS_AZ[m]}</h4>
      ${renderMonthView(year, m, groupFilter, teacherFilter, true)}
    </div>`;
  }
  
  html += '</div>';
  return html;
}

function renderMonthView(year, month, groupFilter, teacherFilter, compact = false) {
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDay = firstDay.getDay(); // 0 = Bazar
  const daysInMonth = lastDay.getDate();
  
  const today = new Date();
  today.setHours(0,0,0,0);
  
  let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr>';
  
  DAYS_AZ.forEach(d => {
    html += `<th style="padding:${compact ? '4px' : '8px'};text-align:center;font-size:${compact ? '11px' : '12px'};color:var(--muted);">${d}</th>`;
  });
  
  html += '</tr></thead><tbody><tr>';
  
  // Bo≈ü g√ºnl…ôr (ayƒ±n ba≈ülanƒüƒ±cƒ±na q…ôd…ôr)
  for(let i = 0; i < startDay; i++) {
    html += '<td></td>';
  }
  
  // G√ºnl…ôri doldur
  for(let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = formatDateDMY(date);
    
    const dayData = getDayData(dateStr, groupFilter, teacherFilter);
    
  let bgColor = '#fff';
    let textColor = '#000';
    let hasNote = false;
    let noteColor = '';
    
    // D…ôrs g√ºn√º yoxlamasƒ± (…ôvv…ôl)
    if(dayData.hasClass) {
      bgColor = '#d1fae5';
      textColor = '#065f46';
    }
    
    // Bayram yoxlamasƒ± (√ñNC∆èLƒ∞K - sonra yoxlanƒ±r v…ô √ºst-√ºst…ô yazƒ±r)
    if(isHoliday(date)) {
      bgColor = '#f3e8ff';
      textColor = '#7c3aed';
    }
    
    // Not yoxlamasƒ±
    if(state.calendarNotes && state.calendarNotes[dateStr]) {
      hasNote = true;
      noteColor = state.calendarNotes[dateStr].status === 'orange' ? '#f97316' : '#fbbf24';
    }
    
    // Bu g√ºn vurƒüulamasƒ±
    const isToday = date.getTime() === today.getTime();
    const border = isToday ? 'border:2px solid var(--blue);' : '';
    
    html += `<td style="padding:${compact ? '6px 2px' : '12px 4px'};text-align:center;background:${bgColor};color:${textColor};${border}cursor:pointer;position:relative;vertical-align:top;" onclick="openDayDetails('${dateStr}')">
      <div style="font-weight:${isToday ? '700' : '500'};font-size:${compact ? '11px' : '14px'};">${day}</div>
      ${hasNote ? `<div style="width:6px;height:6px;background:${noteColor};border-radius:50%;position:absolute;top:4px;right:4px;"></div>` : ''}
    </td>`;
    
    if((startDay + day) % 7 === 0 && day < daysInMonth) {
      html += '</tr><tr>';
    }
  }
  
  // S…ôtiri tamamla
  const remainingCells = (startDay + daysInMonth) % 7;
  if(remainingCells !== 0) {
    for(let i = remainingCells; i < 7; i++) {
      html += '<td></td>';
    }
  }
  
  html += '</tr></tbody></table>';
  return html;
}

function getDayData(dateStr, groupFilter, teacherFilter) {
  const result = {
    hasClass: false,
    groups: [],
    teachers: new Set(),
    sessions: []
  };
  
  const date = parseDateDMY(dateStr);
  const dayOfWeek = date.getDay();
  
  state.groups.filter(g => !g.archived).forEach(g => {
    if(groupFilter !== 'all' && g.name !== groupFilter) return;
    
    const session = SESSIONS[g.code];
    if(!session.days.includes(dayOfWeek)) return;
    
    const schedule = computeScheduleForGroup(g);
    
    schedule.forEach(s => {
      const startDate = parseDateDMY(s.start);
      const endDate = parseDateDMY(s.end);
      
      if(date >= startDate && date <= endDate) {
        // M√º…ôllim filtri yoxla
        let matchesTeacher = teacherFilter === 'all' || 
                            s.teacher === teacherFilter || 
                            s.ta === teacherFilter;
        
        if(matchesTeacher) {
          result.hasClass = true;
          result.groups.push({
            name: g.name,
            code: g.code,
            module: s.module,
            sessionTime: s.sessionTime,
            teacher: s.teacher || '-',
            ta: s.ta || '-'
          });
          
          if(s.teacher) result.teachers.add(s.teacher);
          if(s.ta) result.teachers.add(s.ta);
        }
      }
    });
  });
  
  return result;
}

function openDayDetails(dateStr) {
  const modal = document.getElementById('calendarDayModal');
  const title = document.getElementById('calendarDayTitle');
  const content = document.getElementById('calendarDayContent');
  
  const date = parseDateDMY(dateStr);
  const dayName = ['Bazar', 'Bazar ert…ôsi', '√á…ôr≈ü…ônb…ô ax≈üamƒ±', '√á…ôr≈ü…ônb…ô', 'C√ºm…ô ax≈üamƒ±', 'C√ºm…ô', '≈û…ônb…ô'][date.getDay()];
  
  title.textContent = `${dateStr} - ${dayName}`;
  
  const dayData = getDayData(dateStr, 'all', 'all');
  
  let html = '';
  
  // Bayram yoxlamasƒ±
  if(isHoliday(date)) {
    const holidayName = getAllHolidays().find(h => h.date === dateStr)?.name || 'Bayram';
    html += `<div style="padding:12px;background:#f3e8ff;border-left:4px solid #a855f7;border-radius:6px;margin-bottom:15px;">
      <strong>üéâ ${holidayName}</strong>
    </div>`;
  }
  
  // D…ôrs m…ôlumatlarƒ±
  if(dayData.groups.length > 0) {
    html += '<h4>üìö Bu g√ºn d…ôrsl…ôr:</h4>';
    
    dayData.groups.forEach(g => {
      // G√ºn √º√ß√ºn x√ºsusi t…ôyinat yoxla
      const dayKey = `${g.name}_${dateStr}`;
      const customAssignment = state.dayAssignments && state.dayAssignments[dayKey];
      
      const displayTeacher = customAssignment?.teacher || g.teacher;
      const displayTA = customAssignment?.ta || g.ta;
      
      html += `<div style="padding:12px;border:1px solid #e6edf3;border-radius:6px;margin-bottom:10px;background:#f9fafb;">
        <div style="font-weight:600;margin-bottom:5px;">${g.name} <span class="badge" style="background:#e9d5ff;color:#6b21a8;font-size:10px;">${g.code}</span></div>
        <div style="font-size:13px;color:#666;margin-bottom:3px;">üìñ ${g.module}</div>
        <div style="font-size:12px;color:var(--muted);">‚è∞ ${g.sessionTime}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:5px;">
          üë®‚Äçüè´ M√º…ôllim: ${displayTeacher || '-'}
          ${customAssignment?.teacher ? '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:5px;">D…ôyi≈üdirildi</span>' : ''}
        </div>
        <div style="font-size:12px;color:var(--muted);">
          üë• TA: ${displayTA || '-'}
          ${customAssignment?.ta ? '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:5px;">D…ôyi≈üdirildi</span>' : ''}
        </div>
        
        <!-- M√º…ôllim d…ôyi≈üdirm…ô b√∂lm…ôsi -->
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid #e6edf3;">
          <div style="font-size:12px;font-weight:600;margin-bottom:5px;">Bu g√ºn √º√ß√ºn m√º…ôllim d…ôyi≈üdir:</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <select id="dayTeacher_${g.name}" style="flex:1;min-width:150px;font-size:12px;">
              <option value="">Standart (${g.teacher || '-'})</option>
              ${state.teachers.filter(t => !t.role || t.role === 'teacher' || t.role === 'both').map(t => 
                `<option value="${t.name}" ${displayTeacher === t.name && customAssignment ? 'selected' : ''}>${t.name}</option>`
              ).join('')}
            </select>
            <select id="dayTA_${g.name}" style="flex:1;min-width:150px;font-size:12px;">
              <option value="">Standart (${g.ta || '-'})</option>
              ${state.teachers.filter(t => t.role === 'ta' || t.role === 'both').map(t => 
                `<option value="${t.name}" ${displayTA === t.name && customAssignment ? 'selected' : ''}>${t.name}</option>`
              ).join('')}
            </select>
          </div>
          <button class="btn" style="margin-top:8px;font-size:12px;padding:6px 12px;" onclick="saveDayAssignment('${dateStr}', '${g.name}')">üíæ T…ôyinatƒ± Saxla</button>
          ${customAssignment ? `<button class="btn danger" style="margin-top:8px;margin-left:5px;font-size:12px;padding:6px 12px;" onclick="deleteDayAssignment('${dateStr}', '${g.name}')">üóëÔ∏è Standarta Qaytar</button>` : ''}
        </div>
      </div>`;
    });
  } else {
    html += '<p class="muted">Bu g√ºn d…ôrs yoxdur.</p>';
  }
  
  // Not b√∂lm…ôsi
  html += '<div style="margin-top:20px;padding-top:20px;border-top:2px solid #e6edf3;">';
  html += '<h4>üìù G√ºn √º√ß√ºn qeyd:</h4>';
  
  const note = state.calendarNotes && state.calendarNotes[dateStr] ? state.calendarNotes[dateStr] : {status: 'yellow', text: ''};
  
  html += `<div style="margin-bottom:10px;">
    <label style="display:block;margin-bottom:5px;font-size:13px;">Status:</label>
    <select id="dayNoteStatus" class="select-status-${note.status}">
      <option value="yellow" ${note.status==='yellow'?'selected':''}>‚ö†Ô∏è Normal</option>
      <option value="orange" ${note.status==='orange'?'selected':''}>üî• Vacib</option>
    </select>
  </div>`;
  
  html += `<div>
    <label style="display:block;margin-bottom:5px;font-size:13px;">Qeyd:</label>
    <textarea id="dayNoteText" rows="3" style="width:100%;padding:8px;border:1px solid #e6edf3;border-radius:6px;font-size:13px;" placeholder="Bu g√ºn √º√ß√ºn qeyd …ôlav…ô edin...">${note.text||''}</textarea>
  </div>`;
  
  html += `<div style="margin-top:15px;display:flex;gap:8px;">
    <button class="btn" onclick="saveDayNote('${dateStr}')">üíæ Qeydi Saxla</button>
    ${note.text ? `<button class="btn danger" onclick="deleteDayNote('${dateStr}')">üóëÔ∏è Qeydi Sil</button>` : ''}
  </div>`;
  
  html += '</div>';
  
  content.innerHTML = html;
  
  // Status r…ông d…ôyi≈üikliyi
  const statusSelect = document.getElementById('dayNoteStatus');
  if(statusSelect) {
    statusSelect.onchange = function() {
      this.className = 'select-status-' + this.value;
    };
  }
  
  modal.classList.add('active');
}

function saveDayNote(dateStr) {
  const status = document.getElementById('dayNoteStatus').value;
  const text = document.getElementById('dayNoteText').value.trim();
  
  if(!state.calendarNotes) state.calendarNotes = {};
  
  state.calendarNotes[dateStr] = {status, text};
  
  saveState();
  closeCalendarDayModal();
  renderCalendar();
  
  alert('Qeyd saxlanƒ±ldƒ±! ‚úÖ');
}

function deleteDayNote(dateStr) {
  if(!confirm('Bu qeydi silm…ôk ist…ôdiyinizd…ôn …ôminsiniz?')) return;
  
  if(state.calendarNotes && state.calendarNotes[dateStr]) {
    delete state.calendarNotes[dateStr];
  }
  
  saveState();
  closeCalendarDayModal();
  renderCalendar();
  
  alert('Qeyd silindi! ‚úÖ');
}

// G√ºn √º√ß√ºn m√º…ôllim t…ôyinatƒ±nƒ± saxla
function saveDayAssignment(dateStr, groupName) {
  const teacherSelect = document.getElementById(`dayTeacher_${groupName}`);
  const taSelect = document.getElementById(`dayTA_${groupName}`);
  
  const teacher = teacherSelect ? teacherSelect.value : '';
  const ta = taSelect ? taSelect.value : '';
  
  if (!teacher && !ta) {
    alert('∆èn azƒ± bir m√º…ôllim v…ô ya TA se√ßin!');
    return;
  }
  
  const dayKey = `${groupName}_${dateStr}`;
  
  if (!state.dayAssignments) state.dayAssignments = {};
  
  state.dayAssignments[dayKey] = { teacher, ta, date: dateStr, groupName };
  
  saveState();
  closeCalendarDayModal();
  renderCalendar();
  
  alert('G√ºn √º√ß√ºn t…ôyinat saxlanƒ±ldƒ±! ‚úÖ');
}

// G√ºn t…ôyinatƒ±nƒ± sil
function deleteDayAssignment(dateStr, groupName) {
  if(!confirm('Bu g√ºn√ºn t…ôyinatƒ±nƒ± silm…ôk ist…ôdiyinizd…ôn …ôminsiniz?')) return;
  
  const dayKey = `${groupName}_${dateStr}`;
  
  if(state.dayAssignments && state.dayAssignments[dayKey]) {
    delete state.dayAssignments[dayKey];
  }
  
  saveState();
  closeCalendarDayModal();
  renderCalendar();
  
  alert('T…ôyinat silindi! Standart t…ôyinat b…ôrpa edildi. ‚úÖ');
}

// üìä AYLIK SAAT ANALƒ∞Zƒ∞
// üìä AYLIK SAAT ANALƒ∞Zƒ∞
function generateMonthlyHoursAnalysis() {
// Rol filtri
const roleFilter = document.getElementById('roleFilterSelect')?.value || 'teacher';
  const today = new Date();
  
  // URL-d…ôn v…ô ya default-dan ay/il se√ß
  const urlParams = new URLSearchParams(window.location.hash.substring(1));
  const defaultMonth = today.getMonth();
  const defaultYear = today.getFullYear();
  
  const selectedMonth = parseInt(urlParams.get('analysisMonth')) || defaultMonth;
  const selectedYear = parseInt(urlParams.get('analysisYear')) || defaultYear;
  
  const currentMonth = selectedMonth;
  const currentYear = selectedYear;
  
  // Ayƒ±n ilk v…ô son g√ºnl…ôri
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  
  const monthNames = ['Yanvar', 'Fevral', 'Mart', 'Aprel', 'May', 'ƒ∞yun', 
                     'ƒ∞yul', 'Avqust', 'Sentyabr', 'Oktyabr', 'Noyabr', 'Dekabr'];
  
  const teacherHours = {}; // { teacherName: { total: 0, groups: { groupName: hours } } }
  
  // H…ôr m√º…ôllim √º√ß√ºn saatlarƒ± hesabla
  state.groups.filter(g => !g.archived).forEach(g => {
    const schedule = computeScheduleForGroup(g);
    const session = SESSIONS[g.code];
    const hoursPerDay = session.hoursPerDay;
    const allowedDays = session.days;
    
    schedule.forEach(s => {
      const startDate = parseDateDMY(s.start);
      const endDate = parseDateDMY(s.end);
      
      // Bu modulla ay arasƒ±nda overlap varmƒ±?
      if (endDate < firstDay || startDate > lastDay) return; // Overlap yoxdur
      
      // Ayƒ±n bu modulla k…ôsi≈ü…ôn hiss…ôsini tap
      const moduleStart = startDate < firstDay ? firstDay : startDate;
      const moduleEnd = endDate > lastDay ? lastDay : endDate;
      
      // Bu tarix aralƒ±ƒüƒ±nda h…ôr g√ºn√º yoxla
      let currentDate = new Date(moduleStart);
      
      while (currentDate <= moduleEnd) {
        const dayOfWeek = currentDate.getDay();
        const dateStr = formatDateDMY(currentDate);
        
        // Bu g√ºn d…ôrs g√ºn√ºd√ºrm√º?
        if (allowedDays.includes(dayOfWeek) && !isHoliday(currentDate)) {
          // G√ºn √º√ß√ºn x√ºsusi t…ôyinat varmƒ±?
          const dayKey = `${g.name}_${dateStr}`;
          const customAssignment = state.dayAssignments && state.dayAssignments[dayKey];
          
          const actualTeacher = customAssignment?.teacher || s.teacher;
          const actualTA = customAssignment?.ta || s.ta;
          
          // M√º…ôllim saatlarƒ±nƒ± say
          if (actualTeacher) {
            if (!teacherHours[actualTeacher]) {
              teacherHours[actualTeacher] = { total: 0, groups: {} };
            }
            if (!teacherHours[actualTeacher].groups[g.name]) {
              teacherHours[actualTeacher].groups[g.name] = 0;
            }
            teacherHours[actualTeacher].groups[g.name] += hoursPerDay;
            teacherHours[actualTeacher].total += hoursPerDay;
          }
          
          // TA saatlarƒ±nƒ± say
          if (actualTA) {
            if (!teacherHours[actualTA]) {
              teacherHours[actualTA] = { total: 0, groups: {} };
            }
            if (!teacherHours[actualTA].groups[g.name]) {
              teacherHours[actualTA].groups[g.name] = 0;
            }
            teacherHours[actualTA].groups[g.name] += hoursPerDay;
            teacherHours[actualTA].total += hoursPerDay;
          }
        }
        
        currentDate.setDate(currentDate.getDate() + 1);
      }
    });
  });
  
  // M√º…ôlliml…ôri √ºmumi saata g√∂r…ô sƒ±rala
  // Filtrl…ônmi≈ü m√º…ôlliml…ôr
const filteredTeachers = Object.keys(teacherHours).filter(teacherName => {
  const teacher = state.teachers.find(t => t.name === teacherName);
  const role = teacher?.role || 'teacher';
  
  if (roleFilter === 'all') return true;
  if (roleFilter === 'teacher') return role === 'teacher' || role === 'both';
  if (roleFilter === 'ta') return role === 'ta' || role === 'both';
  if (roleFilter === 'both') return role === 'both';
  return true;
});

const sortedTeachers = filteredTeachers.sort((a, b) => {
  return teacherHours[b].total - teacherHours[a].total;
});
  
  let html = '<div class="dashboard-card">';
  
  // BA≈ûLIQ V∆è Fƒ∞LTRL∆èR
  html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;">
    <h3 style="margin:0;display:flex;align-items:center;gap:8px;">
      <span style="font-size:24px;">‚è±Ô∏è</span> ${monthNames[currentMonth]} ${currentYear} - M√º…ôllim Saat Analizi
    </h3>
	<div style="display:flex;gap:8px;align-items:center;">
  <label style="font-size:13px;color:var(--muted);">Rol:</label>
  <select id="roleFilterSelect" style="padding:6px 10px;border:1px solid #e6edf3;border-radius:6px;font-size:13px;">
    <option value="teacher" selected>M√º…ôlliml…ôr</option>
    <option value="ta">TA-lar</option>
    <option value="both">M√º…ôllim/TA</option>
    <option value="all">Hamƒ±sƒ±</option>
  </select>
</div>
	
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <select id="analysisMonthSelect" style="padding:6px 10px;border:1px solid #e6edf3;border-radius:6px;font-size:13px;">
        ${monthNames.map((m, i) => `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${m}</option>`).join('')}
      </select>
      <select id="analysisYearSelect" style="padding:6px 10px;border:1px solid #e6edf3;border-radius:6px;font-size:13px;">
        ${[2024, 2025, 2026, 2027, 2028, 2029, 2030].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
      </select>
      <button class="btn secondary" style="padding:6px 12px;font-size:13px;" onclick="changeAnalysisMonth(-1)">‚Üê ∆èvv…ôlki</button>
      <button class="btn secondary" style="padding:6px 12px;font-size:13px;" onclick="changeAnalysisMonth(1)">Sonrakƒ± ‚Üí</button>
      <button class="btn" style="padding:6px 12px;font-size:13px;" onclick="resetAnalysisMonth()">üîÑ Bu Ay</button>
    </div>
  </div>`;
  
  html += `<p class="small muted">Ayƒ±n ${firstDay.getDate()} - ${lastDay.getDate()} tarixl…ôri arasƒ± d…ôrs saatlarƒ±</p>`;
  
  if (sortedTeachers.length === 0) {
    html += '<div style="text-align:center;padding:40px;background:#f9fafb;border-radius:8px;"><p class="muted" style="font-size:15px;">üìä Bu ay √º√ß√ºn saat m…ôlumatƒ± yoxdur.</p><p class="small muted">Se√ßilmi≈ü ayda d…ôrs ke√ßirilm…ôyib v…ô ya m√º…ôllim t…ôyin olunmayƒ±b.</p></div>';
  } else {
    html += '<div style="display:grid;gap:12px;max-height:500px;overflow-y:auto;padding-right:5px;">';
    
    sortedTeachers.forEach((teacherName, idx) => {
      const data = teacherHours[teacherName];
      const teacher = state.teachers.find(t => t.name === teacherName);
      const photoURL = teacher?.photoURL;
      const roleColor = teacher?.role === 'teacher' ? '#0369a1' : 
                       teacher?.role === 'ta' ? '#92400e' : '#6b21a8';
      
      html += `<div style="border:2px solid ${idx < 3 ? roleColor : '#e6edf3'};border-radius:10px;padding:15px;background:${idx < 3 ? '#f9fafb' : '#fff'};">
        <div style="display:flex;align-items:center;gap:15px;margin-bottom:12px;">
          <div style="position:relative;">
            ${photoURL ? 
              `<img src="${photoURL}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:3px solid ${roleColor};" />` : 
              `<div style="width:60px;height:60px;border-radius:50%;background:${roleColor};color:white;display:flex;align-items:center;justify-content:center;font-size:24px;">üë§</div>`
            }
            ${idx < 3 ? `<div style="position:absolute;top:-8px;right:-8px;width:28px;height:28px;border-radius:50%;background:white;border:2px solid ${roleColor};display:flex;align-items:center;justify-content:center;font-size:16px;">${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â'}</div>` : ''}
          </div>
          <div style="flex:1;">
            <div style="font-weight:700;font-size:16px;">${teacherName}</div>
            <div style="font-size:12px;color:var(--muted);">${getRoleBadge(teacher?.role || 'teacher').replace('class="badge', 'style="padding:2px 6px;border-radius:4px;font-size:10px;" class="badge')}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:32px;font-weight:700;color:${roleColor};">${data.total}</div>
            <div style="font-size:12px;color:var(--muted);">saat</div>
          </div>
        </div>
        
        <div style="background:white;padding:10px;border-radius:6px;border:1px solid #e6edf3;">
          <div style="font-size:13px;font-weight:600;margin-bottom:8px;color:var(--muted);">üìö Qrup √ºzr…ô saatlar:</div>
          ${Object.keys(data.groups).sort((a, b) => data.groups[b] - data.groups[a]).map(groupName => {
            const hours = data.groups[groupName];
            const percent = ((hours / data.total) * 100).toFixed(0);
            return `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;padding:6px;background:#f9fafb;border-radius:4px;">
              <span style="font-size:13px;font-weight:500;">${groupName}</span>
              <div style="display:flex;align-items:center;gap:8px;">
                <div style="width:100px;height:6px;background:#e6edf3;border-radius:3px;overflow:hidden;">
                  <div style="width:${percent}%;height:100%;background:${roleColor};"></div>
                </div>
                <span style="font-weight:600;font-size:13px;color:${roleColor};min-width:50px;text-align:right;">${hours} saat</span>
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
    });
    
    html += '</div>';
  }
  
  html += '</div>';
  
  // Event listener'l…ôr …ôlav…ô et
  setTimeout(() => {
    const monthSelect = document.getElementById('analysisMonthSelect');
    const yearSelect = document.getElementById('analysisYearSelect');
    
    if (monthSelect) {
      monthSelect.onchange = () => {
        updateAnalysisURL(parseInt(monthSelect.value), parseInt(yearSelect.value));
        renderDashboard();
      };
    }
    
    if (yearSelect) {
      yearSelect.onchange = () => {
        updateAnalysisURL(parseInt(monthSelect.value), parseInt(yearSelect.value));
        renderDashboard();
      };
    }
	const roleFilterSelect = document.getElementById('roleFilterSelect');
if (roleFilterSelect) {
  roleFilterSelect.onchange = () => {
    renderDashboard();
  };
}
	
  }, 100);
  
  return html;
}

// URL-i yenil…ô (s…ôhif…ô yenil…ônm…ôd…ôn)
function updateAnalysisURL(month, year) {
  const newHash = `#analysisMonth=${month}&analysisYear=${year}`;
  history.replaceState(null, '', newHash);
}

// Ayƒ± d…ôyi≈üdir (¬±1 ay)
function changeAnalysisMonth(direction) {
  const urlParams = new URLSearchParams(window.location.hash.substring(1));
  const today = new Date();
  
  let currentMonth = parseInt(urlParams.get('analysisMonth')) || today.getMonth();
  let currentYear = parseInt(urlParams.get('analysisYear')) || today.getFullYear();
  
  currentMonth += direction;
  
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  
  updateAnalysisURL(currentMonth, currentYear);
  renderDashboard();
}

// Bu aya qayƒ±t
function resetAnalysisMonth() {
  const today = new Date();
  updateAnalysisURL(today.getMonth(), today.getFullYear());
  renderDashboard();
}

// ============== T∆èQVƒ∞M Sƒ∞STEMƒ∞ SONU ==============

// Tab Navigation
document.querySelectorAll('.main-tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.page + 'Page').classList.add('active');
    
    if (tab.dataset.page === 'dashboard') {
      renderDashboard();
    }
  };
});

// Dashboard Render Function
function renderDashboard() {
  const container = document.getElementById('dashboardContent');
  const activeGroups = state.groups.filter(g => !g.archived);
  
  if (activeGroups.length === 0) {
    container.innerHTML = '<div class="dashboard-card"><p class="muted">Aktiv qrup yoxdur. Qrup …ôlav…ô edin.</p></div>';
    return;
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let html = '';
  
  // √úST Hƒ∞SS∆è: Statistika Kartlarƒ±
  html += '<div class="dashboard-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">';
  
  // Aktiv Qruplar
  html += `<div class="dashboard-card" style="text-align:center;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;">
    <div style="font-size:42px;font-weight:700;">${activeGroups.length}</div>
    <div style="font-size:14px;margin-top:8px;opacity:0.9;">Aktiv Qrup</div>
  </div>`;
  
  // M√º…ôlliml…ôr
  html += `<div class="dashboard-card" style="text-align:center;padding:20px;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;border:none;">
    <div style="font-size:42px;font-weight:700;">${state.teachers.length}</div>
    <div style="font-size:14px;margin-top:8px;opacity:0.9;">M√º…ôllim/TA</div>
  </div>`;
  
  // H…ôll G√∂zl…ôy…ôn Qeydl…ôr
  let pendingNotes = 0;
  activeGroups.forEach(g => {
    const notes = g.weeklyNotes || {};
    Object.values(notes).forEach(n => {
      if (n.status === 'orange') pendingNotes++;
    });
  });
  
  html += `<div class="dashboard-card" style="text-align:center;padding:20px;background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:white;border:none;">
    <div style="font-size:42px;font-weight:700;">${pendingNotes}</div>
    <div style="font-size:14px;margin-top:8px;opacity:0.9;">‚ö†Ô∏è T∆èCƒ∞Lƒ∞ Qeyd</div>
  </div>`;
  
  // Tamamlanan Modullar
  let completedModules = 0;
  activeGroups.forEach(g => {
    const schedule = computeScheduleForGroup(g);
    schedule.forEach(s => {
      if (parseDateDMY(s.end) < today) completedModules++;
    });
  });
  
  html += `<div class="dashboard-card" style="text-align:center;padding:20px;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;border:none;">
    <div style="font-size:42px;font-weight:700;">${completedModules}</div>
    <div style="font-size:14px;margin-top:8px;opacity:0.9;">‚úì Tamamlanmƒ±≈ü Modul</div>
  </div>`;
  
  html += '</div>'; // grid end
  
  // ORTA Hƒ∞SS∆è: 2 S√ºtun Layout
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px;">';
  
  // SOL: Yaxƒ±n H…ôft…ôlik Qeydl…ôr (Scroll il…ô)
  html += '<div class="dashboard-card">';
  html += '<h3 style="margin-top:0;display:flex;align-items:center;gap:8px;"><span style="font-size:24px;">üìå</span> Yaxƒ±n H…ôft…ôlik Qeydl…ôr</h3>';
  
  let upcomingNotes = [];
  activeGroups.forEach(g => {
    const notes = g.weeklyNotes || {};
    Object.keys(notes).forEach(dateStr => {
      const noteDate = parseDateDMY(dateStr);
      const daysDiff = Math.ceil((noteDate - today) / (1000 * 60 * 60 * 24));
      
      if (daysDiff >= -7 && daysDiff <= 14 && notes[dateStr].status !== 'green') {
        upcomingNotes.push({
          group: g.name,
          date: dateStr,
          dateObj: noteDate,
          daysDiff: daysDiff,
          status: notes[dateStr].status,
          text: notes[dateStr].text
        });
      }
    });
  });
  
  upcomingNotes.sort((a, b) => a.dateObj - b.dateObj);
  
  if (upcomingNotes.length === 0) {
    html += '<p class="small muted">Yaxƒ±n tarixd…ô qeyd yoxdur.</p>';
  } else {
    html += '<div style="max-height:400px;overflow-y:auto;padding-right:5px;">';
    upcomingNotes.forEach(note => {
      const statusColor = note.status === 'orange' ? 'var(--orange)' : 'var(--yellow)';
      const statusIcon = note.status === 'orange' ? '‚ö†Ô∏è' : '‚è≥';
      const statusText = note.status === 'orange' ? 'Bu h…ôft…ô H∆èLL' : 'G…ôl…ôn h…ôft…ô';
      const daysText = note.daysDiff === 0 ? 'Bu g√ºn' : 
                      note.daysDiff === 1 ? 'Sabah' : 
                      note.daysDiff > 0 ? `${note.daysDiff} g√ºn sonra` : 
                      `${Math.abs(note.daysDiff)} g√ºn …ôvv…ôl`;
      
      html += `<div style="padding:12px;border-left:4px solid ${statusColor};background:#f9fafb;margin-bottom:10px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px;">
          <strong style="font-size:14px;">${note.group}</strong>
          <span style="font-size:11px;color:var(--muted);background:white;padding:2px 8px;border-radius:12px;">${daysText}</span>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:5px;">${note.date} - ${statusIcon} ${statusText}</div>
        ${note.text ? `<div style="font-size:13px;color:#333;margin-top:6px;padding-top:6px;border-top:1px dashed #e0e0e0;">${note.text}</div>` : ''}
      </div>`;
    });
    html += '</div>';
  }
  
  html += '</div>'; // Sol kart sonu
  
  // SAƒû: M√º…ôllim Y√ºk√º Analizi (Scroll il…ô)
  html += '<div class="dashboard-card">';
  html += '<h3 style="margin-top:0;display:flex;align-items:center;gap:8px;"><span style="font-size:24px;">üë•</span> M√º…ôllim Y√ºk√º Analizi</h3>';
  
  const teacherLoad = {};
  
  activeGroups.forEach(g => {
    const schedule = computeScheduleForGroup(g);
    schedule.forEach(s => {
      // M√º…ôllim
      if (s.teacher) {
        if (!teacherLoad[s.teacher]) {
          teacherLoad[s.teacher] = { 
            name: s.teacher, 
            groups: new Set(), 
            modules: 0,
            role: state.teachers.find(t => t.name === s.teacher)?.role || 'teacher'
          };
        }
        teacherLoad[s.teacher].groups.add(s.groupName);
        teacherLoad[s.teacher].modules++;
      }
      
      // TA
      if (s.ta) {
        if (!teacherLoad[s.ta]) {
          teacherLoad[s.ta] = { 
            name: s.ta, 
            groups: new Set(), 
            modules: 0,
            role: state.teachers.find(t => t.name === s.ta)?.role || 'ta'
          };
        }
        teacherLoad[s.ta].groups.add(s.groupName);
        teacherLoad[s.ta].modules++;
      }
    });
  });
  
  const sortedTeachers = Object.values(teacherLoad).sort((a, b) => b.modules - a.modules);
  
  if (sortedTeachers.length === 0) {
    html += '<p class="small muted">He√ß bir m√º…ôllim t…ôyin olunmayƒ±b.</p>';
  } else {
    html += '<div style="max-height:400px;overflow-y:auto;padding-right:5px;">';
    
    sortedTeachers.forEach((t, idx) => {
    const groupCount = t.groups.size;
    const roleColor = t.role === 'teacher' ? '#0369a1' : 
                   t.role === 'ta' ? '#92400e' : '#6b21a8';
    const roleText = t.role === 'teacher' ? 'M√º…ôllim' : 
                  t.role === 'ta' ? 'TA' : 'M√º…ôllim/TA';
    
    // M√º…ôllimin profil ≈ü…ôklini tap
    const teacher = state.teachers.find(tt => tt.name === t.name);
    const photoURL = teacher && teacher.photoURL;
  
    html += `<div style="display:flex;align-items:center;gap:15px;padding:15px;background:#f9fafb;border-radius:6px;margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
        <div style="position:relative;width:50px;height:50px;flex-shrink:0;">
            ${photoURL ? 
                `<img src="${photoURL}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;border:3px solid ${roleColor};" alt="${t.name}" />` : 
                `<div style="width:50px;height:50px;border-radius:50%;background:${roleColor};color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;">üë§</div>`
            }
            <div style="position:absolute;top:-5px;left:-5px;width:24px;height:24px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:${roleColor};border:2px solid ${roleColor};box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                ${idx + 1}
            </div>
        </div>
        <div style="flex:1;">
            <div style="font-weight:600;font-size:15px;margin-bottom:3px;">${t.name}</div>
            <div style="font-size:11px;color:var(--muted);">${roleText}</div>
        </div>
        <div style="text-align:right;">
            <div style="font-size:20px;font-weight:700;color:${roleColor};">${groupCount}</div>
            <div style="font-size:11px;color:var(--muted);">qrup</div>
        </div>
        <div style="text-align:right;">
            <div style="font-size:16px;font-weight:600;color:var(--muted);">${t.modules}</div>
            <div style="font-size:11px;color:var(--muted);">modul</div>
        </div>
    </div>`;
});
    
    html += '</div>';
  }
  
  html += '</div>'; // Saƒü kart sonu
  
  html += '</div>'; // 2 s√ºtun grid sonu
  
  // ALT Hƒ∞SS∆è: Aktiv Qruplarƒ±n Modul Statusu
  html += generatePerformanceTable();
  html += generateMonthlyCalendar();
  html += generateSessionLoadAnalysis();
  html += generateModuleCompletionChart();
  html += '<div class="dashboard-card" style="margin-top:15px;">';
  html += '<h3 style="margin-top:0;display:flex;align-items:center;gap:8px;"><span style="font-size:24px;">üéØ</span> Aktiv Qruplarƒ±n Modul Statusu</h3>';
  
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:12px;">';
  
  activeGroups.forEach(g => {
    const schedule = computeScheduleForGroup(g);
    let currentModule = null;
    let nextModule = null;
    
    schedule.forEach((s, idx) => {
      const startDate = parseDateDMY(s.start);
      const endDate = parseDateDMY(s.end);
      
      if (today >= startDate && today <= endDate) {
        currentModule = s;
      } else if (today < startDate && !nextModule) {
        nextModule = s;
      }
    });
    
    html += `<div style="border:1px solid #e6edf3;border-radius:8px;padding:15px;background:linear-gradient(to bottom,#ffffff,#f9fafb);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div>
          <strong style="font-size:15px;">${g.name}</strong>
          <span class="badge" style="background:#e9d5ff;color:#6b21a8;margin-left:8px;font-size:10px;">${g.code}</span>
        </div>
      </div>`;
    
    if (currentModule) {
      const totalDays = Math.ceil((parseDateDMY(currentModule.end) - parseDateDMY(currentModule.start)) / (1000 * 60 * 60 * 24)) + 1;
      const passedDays = Math.ceil((today - parseDateDMY(currentModule.start)) / (1000 * 60 * 60 * 24)) + 1;
      const remainingDays = Math.ceil((parseDateDMY(currentModule.end) - today) / (1000 * 60 * 60 * 24));
      const progress = Math.min(100, Math.max(0, (passedDays / totalDays) * 100));
      
      html += `<div class="module-progress">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
          <span style="font-size:13px;font-weight:600;">üìö ${currentModule.module}</span>
          <span class="status-badge active">Davam edir</span>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:5px;">
          ${currentModule.start} - ${currentModule.end}
        </div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:5px;">
          M√º…ôllim: ${currentModule.teacher || 'T…ôyin olunmayƒ±b'}
        </div>
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:3px;">
          <span>${passedDays} g√ºn ke√ßdi</span>
          <span>${remainingDays} g√ºn qalƒ±b</span>
        </div>
        <div class="module-progress-bar">
          <div class="module-progress-fill" style="width:${progress}%;"></div>
        </div>
     </div>`;
    } else {
  // Layih…ô m…ôrh…ôl…ôl…ôrini yoxla
  const allModules = schedule;
  const restModule = allModules.find(m => m.isRest);
  const projectModule = allModules.find(m => m.isProject);
  const presentationModule = allModules.find(m => m.isPresentation);
  
  if (restModule) {
    const restStart = parseDateDMY(restModule.start);
    const restEnd = parseDateDMY(restModule.end);
    
    if (today >= restStart && today <= restEnd) {
      const daysLeft = Math.ceil((restEnd - today) / (1000 * 60 * 60 * 24));
      html += `<div class="module-progress" style="background:#e0f2fe;border:2px solid #0284c7;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
          <span style="font-size:13px;font-weight:600;">üèñÔ∏è ƒ∞stirah…ôt</span>
          <span class="status-badge" style="background:#0284c7;color:white;">Davam edir</span>
        </div>
        <div style="font-size:12px;color:var(--muted);">
          ${daysLeft === 0 ? 'Bu g√ºn bitir' : daysLeft + ' g√ºn qalƒ±b'} ‚Ä¢ ${restModule.start} - ${restModule.end}
        </div>
      </div>`;
    }
  }
  
  if (projectModule) {
    const projectStart = parseDateDMY(projectModule.start);
    const projectEnd = parseDateDMY(projectModule.end);
    
    if (today >= projectStart && today <= projectEnd) {
      const daysLeft = Math.ceil((projectEnd - today) / (1000 * 60 * 60 * 24));
      const totalDays = 40;
      const passedDays = totalDays - daysLeft;
      const progress = (passedDays / totalDays) * 100;
      
      html += `<div class="module-progress" style="background:#fef3c7;border:2px solid #f59e0b;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
          <span style="font-size:13px;font-weight:600;">üíº Layih…ô ƒ∞≈üi</span>
          <span class="status-badge" style="background:#f59e0b;color:white;">Hazƒ±rlanƒ±r</span>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:5px;">
          ${projectModule.start} - ${projectModule.end}
        </div>
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:3px;">
          <span>${passedDays} g√ºn ke√ßdi</span>
          <span>${daysLeft} g√ºn qalƒ±b</span>
        </div>
        <div class="module-progress-bar">
          <div class="module-progress-fill" style="width:${progress}%;background:#f59e0b;"></div>
        </div>
      </div>`;
    }
  }
  
  if (presentationModule && !currentModule && !restModule && !projectModule) {
    const presentationDate = parseDateDMY(presentationModule.start);
    const daysUntil = Math.ceil((presentationDate - today) / (1000 * 60 * 60 * 24));
    
    if (daysUntil >= 0 && daysUntil <= 14) {
      html += `<div class="module-progress" style="background:#ddd6fe;border:2px solid #8b5cf6;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
          <span style="font-size:13px;font-weight:600;">üéì T…ôqdimat</span>
          <span class="status-badge" style="background:#8b5cf6;color:white;">Yaxƒ±nla≈üƒ±r</span>
        </div>
        <div style="font-size:12px;color:var(--muted);">
          ${daysUntil === 0 ? 'Bu g√ºn!' : daysUntil + ' g√ºn sonra'} ‚Ä¢ ${presentationModule.start}
        </div>
      </div>`;
    }
  }
	
	}

if (nextModule) {
      const daysUntilStart = Math.ceil((parseDateDMY(nextModule.start) - today) / (1000 * 60 * 60 * 24));
      html += `<div class="module-progress">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
          <span style="font-size:13px;font-weight:600;">üìö ${nextModule.module}</span>
          <span class="status-badge" style="background:#fef3c7;color:#92400e;">G√∂zl…ôm…ôd…ô</span>
        </div>
        <div style="font-size:12px;color:var(--muted);">
          ${daysUntilStart} g√ºn sonra ba≈ülayacaq (${nextModule.start})
        </div>
      </div>`;
    } else {
      html += '<p class="small muted">Modul m…ôlumatƒ± yoxdur.</p>';
    }
    
    html += '</div>';
  });
  
  html += '</div>'; // Grid sonu
  html += '</div>'; // Kart sonu
  html += generateMonthlyHoursAnalysis();  // AYLIK SAAT ANALƒ∞Zƒ∞
  
  container.innerHTML = html;
}

// ƒ∞lk y√ºkl…ônm…ôd…ô dashboard g√∂st…ôr
setTimeout(() => {
  if (auth.currentUser) {
    renderDashboard();
  }
}, 500);

updateModuleHours(groupCodeInput.value);

// üèÜ PERFORMANS C∆èDV∆èLƒ∞ - Qƒ∞YM∆èT ∆èSASLI
function generatePerformanceTable() {
    const activeGroups = state.groups.filter(g => !g.archived);
    
    if (activeGroups.length === 0) {
        return '<p class="muted">Aktiv qrup yoxdur.</p>';
    }

    const groupStats = [];

    activeGroups.forEach(g => {
        const grading = state.grading && state.grading[g.name];
        
        if (!grading || !grading.students || grading.students.length === 0) {
            groupStats.push({
                name: g.name,
                code: g.code,
                studentCount: 0,
                avgGrade: 0,
                hasData: false
            });
            return;
        }

        let totalGrades = 0;
        let gradeCount = 0;

        // H…ôr assessment-d…ôn qiym…ôtl…ôri topla
        if (grading.assessments && grading.assessments.length > 0) {
            grading.assessments.forEach(assessment => {
                if (assessment.grades) {
                    Object.values(assessment.grades).forEach(grade => {
                        const numGrade = parseFloat(grade);
                        if (!isNaN(numGrade) && numGrade > 0) {
                            totalGrades += numGrade;
                            gradeCount++;
                        }
                    });
                }
            });
        }

        const avgGrade = gradeCount > 0 ? (totalGrades / gradeCount).toFixed(2) : 0;

        groupStats.push({
            name: g.name,
            code: g.code,
            studentCount: grading.students.length,
            assessmentCount: grading.assessments ? grading.assessments.length : 0,
            avgGrade: parseFloat(avgGrade),
            hasData: gradeCount > 0
        });
    });

    // Ortalamaya g√∂r…ô sƒ±rala (…ôn y√ºks…ôk …ôvv…ôl)
    groupStats.sort((a, b) => b.avgGrade - a.avgGrade);

    let html = '<div class="dashboard-card">';
    html += '<h3 style="margin-top:0;display:flex;align-items:center;gap:8px;"><span style="font-size:24px;">üèÜ</span> Qrup Performans Reytinqi</h3>';
    html += '<p class="small muted">Qiym…ôtl…ôndirm…ô sistemind…ôki ortalama bala g√∂r…ô sƒ±ralanƒ±b</p>';

    if (groupStats.every(g => !g.hasData)) {
        html += '<div style="text-align:center;padding:30px;background:#f9fafb;border-radius:8px;"><p class="muted">H…ôl…ô he√ß bir qrupda qiym…ôt daxil edilm…ôyib.</p><p class="small muted">Qiym…ôtl…ôndirm…ô b√∂lm…ôsin…ô ke√ßid edin v…ô t…ôl…ôb…ôl…ôr…ô qiym…ôt verin.</p></div>';
    } else {
        html += '<div style="display:grid;gap:10px;max-height:400px;overflow-y:auto;padding-right:5px;">';

        groupStats.forEach((g, idx) => {
            let medalIcon = '';
            let borderColor = '#e6edf3';
            
            if (g.hasData) {
                if (idx === 0) { medalIcon = 'ü•á'; borderColor = '#FFD700'; }
                else if (idx === 1) { medalIcon = 'ü•à'; borderColor = '#C0C0C0'; }
                else if (idx === 2) { medalIcon = 'ü•â'; borderColor = '#CD7F32'; }
            }

            const gradeColor = g.avgGrade >= 80 ? 'var(--green)' : 
                              g.avgGrade >= 60 ? 'var(--yellow)' : 
                              g.avgGrade > 0 ? 'var(--red)' : 'var(--muted)';

            html += `<div style="display:flex;align-items:center;gap:15px;padding:15px;border:2px solid ${borderColor};border-radius:8px;background:${g.hasData ? '#fff' : '#f9fafb'};">
                <div style="width:50px;height:50px;border-radius:50%;background:${g.hasData ? 'linear-gradient(135deg,#667eea,#764ba2)' : '#e6edf3'};color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;flex-shrink:0;">
                    ${medalIcon || (idx + 1)}
                </div>
                <div style="flex:1;">
                    <div style="font-weight:600;font-size:15px;margin-bottom:3px;">
                        ${g.name}
                        <span class="badge" style="background:#e9d5ff;color:#6b21a8;font-size:10px;margin-left:5px;">${g.code}</span>
                    </div>
                    <div style="font-size:12px;color:var(--muted);">
                        ${g.studentCount} t…ôl…ôb…ô ¬∑ ${g.assessmentCount} qiym…ôtl…ôndirm…ô
                    </div>
                </div>
                <div style="text-align:center;min-width:80px;">
                    ${g.hasData ? `
                        <div style="font-size:28px;font-weight:700;color:${gradeColor};">${g.avgGrade}</div>
                        <div style="font-size:11px;color:var(--muted);margin-top:2px;">ortalama</div>
                    ` : `
                        <div style="font-size:14px;color:var(--muted);">-</div>
                        <div style="font-size:11px;color:var(--muted);">m…ôlumat yoxdur</div>
                    `}
                </div>
            </div>`;
        });

        html += '</div>';
    }

    html += '</div>';
    return html;
}

// üìÖ 1Ô∏è‚É£ KALENDARƒ∞YA G√ñR√úN√ú≈û√ú - Bu ay bit…ôn modullar
function generateMonthlyCalendar() {
    const activeGroups = state.groups.filter(g => !g.archived);
    
    if (activeGroups.length === 0) {
        return '<p class="muted">Aktiv qrup yoxdur.</p>';
    }

    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    // Bu ay bit…ôn modullarƒ± topla
    const thisMonthModules = [];
    
    activeGroups.forEach(g => {
        const schedule = computeScheduleForGroup(g);
        schedule.forEach(s => {
            const endDate = parseDateDMY(s.end);
            if (endDate.getMonth() === currentMonth && endDate.getFullYear() === currentYear) {
                thisMonthModules.push({
                    groupName: g.name,
                    groupCode: g.code,
                    module: s.module,
                    endDate: endDate,
                    endDateStr: s.end,
                    teacher: s.teacher || '-',
                    sessionTime: s.sessionTime
                });
            }
        });
    });

    // Tarix…ô g√∂r…ô sƒ±rala
    thisMonthModules.sort((a, b) => a.endDate - b.endDate);

    const monthNames = ['Yanvar', 'Fevral', 'Mart', 'Aprel', 'May', 'ƒ∞yun', 
                       'ƒ∞yul', 'Avqust', 'Sentyabr', 'Oktyabr', 'Noyabr', 'Dekabr'];

    let html = '<div class="dashboard-card">';
    html += `<h3 style="margin-top:0;display:flex;align-items:center;gap:8px;"><span style="font-size:24px;">üìÖ</span> ${monthNames[currentMonth]} ${currentYear} - Bit…ôn Modullar</h3>`;

    if (thisMonthModules.length === 0) {
        html += '<div style="text-align:center;padding:30px;background:#f9fafb;border-radius:8px;">';
        html += '<p class="muted">Bu ay he√ß bir modul bitmir.</p>';
        html += '</div>';
    } else {
        html += `<p class="small muted">Bu ay <strong>${thisMonthModules.length}</strong> modul tamamlanacaq</p>`;
        html += '<div style="display:grid;gap:10px;max-height:350px;overflow-y:auto;padding-right:5px;">';
        
        thisMonthModules.forEach((m, idx) => {
            const daysUntilEnd = Math.ceil((m.endDate - today) / (1000 * 60 * 60 * 24));
            const isPast = daysUntilEnd < 0;
            const isToday = daysUntilEnd === 0;
            
            let statusBadge = '';
            let borderColor = '#e6edf3';
            
            if (isPast) {
                statusBadge = '<span style="background:#10b981;color:white;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">‚úì Bitdi</span>';
                borderColor = '#10b981';
            } else if (isToday) {
                statusBadge = '<span style="background:#f59e0b;color:white;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">üî• Bu g√ºn</span>';
                borderColor = '#f59e0b';
            } else if (daysUntilEnd <= 3) {
                statusBadge = '<span style="background:#ef4444;color:white;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">‚ö†Ô∏è Tezlikl…ô</span>';
                borderColor = '#ef4444';
            } else {
                statusBadge = `<span style="background:#6b7280;color:white;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">${daysUntilEnd} g√ºn</span>`;
            }

            html += `<div style="padding:12px;border-left:4px solid ${borderColor};background:#f9fafb;border-radius:6px;display:flex;justify-content:space-between;align-items:center;gap:10px;">
                <div style="flex:1;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:4px;">
                        ${m.groupName} <span class="badge" style="background:#e9d5ff;color:#6b21a8;font-size:10px;">${m.groupCode}</span>
                    </div>
                    <div style="font-size:13px;color:#333;margin-bottom:3px;">${m.module}</div>
                    <div style="font-size:11px;color:var(--muted);">
                        üìç ${m.endDateStr} ¬∑ ‚è∞ ${m.sessionTime} ¬∑ üë®‚Äçüè´ ${m.teacher}
                    </div>
                </div>
                <div style="text-align:right;">
                    ${statusBadge}
                </div>
            </div>`;
        });
        
        html += '</div>';
    }

    html += '</div>';
    return html;
}

// ‚è∞ 2Ô∏è‚É£ SEANS Y√úK√ú ANALƒ∞Zƒ∞ - Hansƒ± saatlarda daha √ßox d…ôrs var
function generateSessionLoadAnalysis() {
    const activeGroups = state.groups.filter(g => !g.archived);
    
    if (activeGroups.length === 0) {
        return '<p class="muted">Aktiv qrup yoxdur.</p>';
    }

    const sessionLoad = {
        'CS1': { name: '09:00-13:00 (H…ôft…ô i√ßi)', groups: [], teachers: new Set() },
        'CS2': { name: '14:00-18:00 (H…ôft…ô i√ßi)', groups: [], teachers: new Set() },
        'CS3': { name: '19:00-21:45 (H…ôft…ô i√ßi)', groups: [], teachers: new Set() },
        'CS4': { name: '10:00-14:45 (H…ôft…ô sonu)', groups: [], teachers: new Set() },
        'CS5': { name: '15:30-20:15 (H…ôft…ô sonu)', groups: [], teachers: new Set() }
    };

    activeGroups.forEach(g => {
        sessionLoad[g.code].groups.push(g.name);
        
        // Bu qrupdakƒ± b√ºt√ºn m√º…ôlliml…ôri topla
        const schedule = computeScheduleForGroup(g);
        schedule.forEach(s => {
            if (s.teacher) sessionLoad[g.code].teachers.add(s.teacher);
            if (s.ta) sessionLoad[g.code].teachers.add(s.ta);
        });
    });

    // ∆èn y√ºkl√º seans
    let maxLoad = 0;
    let maxSessionCode = '';
    Object.keys(sessionLoad).forEach(code => {
        if (sessionLoad[code].groups.length > maxLoad) {
            maxLoad = sessionLoad[code].groups.length;
            maxSessionCode = code;
        }
    });

    let html = '<div class="dashboard-card">';
    html += '<h3 style="margin-top:0;display:flex;align-items:center;gap:8px;"><span style="font-size:24px;">‚è∞</span> Seans Y√ºk√º Analizi</h3>';
    html += '<p class="small muted">H…ôr seansdakƒ± qrup v…ô m√º…ôllim sayƒ±</p>';

    html += '<div style="display:grid;gap:10px;max-height:400px;overflow-y:auto;padding-right:5px;">';

    Object.keys(sessionLoad).forEach(code => {
        const session = sessionLoad[code];
        const groupCount = session.groups.length;
        const teacherCount = session.teachers.size;
        const isMaxLoad = code === maxSessionCode && groupCount > 0;
        
        const loadPercent = maxLoad > 0 ? (groupCount / maxLoad) * 100 : 0;
        
        let loadColor = '#10b981';
        let loadText = 'Rahat';
        if (loadPercent > 80) { loadColor = '#ef4444'; loadText = 'Y√ºkl√º'; }
        else if (loadPercent > 50) { loadColor = '#f59e0b'; loadText = 'Orta'; }

        html += `<div style="padding:15px;border:2px solid ${isMaxLoad ? loadColor : '#e6edf3'};border-radius:8px;background:${groupCount > 0 ? '#fff' : '#f9fafb'};">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div>
                    <div style="font-weight:600;font-size:14px;">${code} - ${session.name}</div>
                    ${isMaxLoad && groupCount > 0 ? '<span style="background:' + loadColor + ';color:white;padding:2px 8px;border-radius:12px;font-size:10px;font-weight:600;margin-top:4px;display:inline-block;">üî• ∆èn y√ºkl√º seans</span>' : ''}
                </div>
                <div style="text-align:right;">
                    <div style="font-size:24px;font-weight:700;color:${loadColor};">${groupCount}</div>
                    <div style="font-size:11px;color:var(--muted);">${loadText}</div>
                </div>
            </div>
            
            ${groupCount > 0 ? `
                <div style="display:flex;gap:15px;font-size:12px;color:var(--muted);">
                    <div>üìö <strong>${groupCount}</strong> qrup</div>
                    <div>üë• <strong>${teacherCount}</strong> m√º…ôllim/TA</div>
                </div>
                <div style="margin-top:8px;">
                    <div style="height:6px;background:#e6edf3;border-radius:3px;overflow:hidden;">
                        <div style="width:${loadPercent}%;height:100%;background:${loadColor};transition:width 0.3s;"></div>
                    </div>
                </div>
                <div style="margin-top:8px;font-size:11px;color:var(--muted);">
                    Qruplar: ${session.groups.join(', ')}
                </div>
            ` : '<p class="small muted">Bu seansta qrup yoxdur</p>'}
        </div>`;
    });

    html += '</div>';
    html += '</div>';
    return html;
}

// üìà 4Ô∏è‚É£ QRAFƒ∞KL∆èR - Modul tamamlanma statistikasƒ±
function generateModuleCompletionChart() {
    const activeGroups = state.groups.filter(g => !g.archived);
    
    if (activeGroups.length === 0) {
        return '<p class="muted">Aktiv qrup yoxdur.</p>';
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const moduleStats = {
        completed: 0,
        inProgress: 0,
        upcoming: 0,
        total: 0
    };

    const moduleDetails = {};

    activeGroups.forEach(g => {
        const schedule = computeScheduleForGroup(g);
        
        schedule.forEach(s => {
            moduleStats.total++;
            
            const startDate = parseDateDMY(s.start);
            const endDate = parseDateDMY(s.end);

            if (!moduleDetails[s.module]) {
                moduleDetails[s.module] = { completed: 0, inProgress: 0, upcoming: 0 };
            }

            if (today > endDate) {
                moduleStats.completed++;
                moduleDetails[s.module].completed++;
            } else if (today >= startDate && today <= endDate) {
                moduleStats.inProgress++;
                moduleDetails[s.module].inProgress++;
            } else {
                moduleStats.upcoming++;
                moduleDetails[s.module].upcoming++;
            }
        });
    });

    const completedPercent = moduleStats.total > 0 ? ((moduleStats.completed / moduleStats.total) * 100).toFixed(1) : 0;
    const inProgressPercent = moduleStats.total > 0 ? ((moduleStats.inProgress / moduleStats.total) * 100).toFixed(1) : 0;
    const upcomingPercent = moduleStats.total > 0 ? ((moduleStats.upcoming / moduleStats.total) * 100).toFixed(1) : 0;

    let html = '<div class="dashboard-card">';
    html += '<h3 style="margin-top:0;display:flex;align-items:center;gap:8px;"><span style="font-size:24px;">üìà</span> Modul Tamamlanma Statistikasƒ±</h3>';

    // √úmumi statistika
    html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">';
    
    html += `<div style="text-align:center;padding:15px;background:linear-gradient(135deg,#10b981,#059669);border-radius:8px;color:white;">
        <div style="font-size:32px;font-weight:700;">${moduleStats.completed}</div>
        <div style="font-size:12px;opacity:0.9;">‚úì Tamamlandƒ±</div>
        <div style="font-size:11px;opacity:0.8;margin-top:3px;">${completedPercent}%</div>
    </div>`;

    html += `<div style="text-align:center;padding:15px;background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:8px;color:white;">
        <div style="font-size:32px;font-weight:700;">${moduleStats.inProgress}</div>
        <div style="font-size:12px;opacity:0.9;">üîÑ Davam edir</div>
        <div style="font-size:11px;opacity:0.8;margin-top:3px;">${inProgressPercent}%</div>
    </div>`;

    html += `<div style="text-align:center;padding:15px;background:linear-gradient(135deg,#6b7280,#4b5563);border-radius:8px;color:white;">
        <div style="font-size:32px;font-weight:700;">${moduleStats.upcoming}</div>
        <div style="font-size:12px;opacity:0.9;">‚è≥ G√∂zl…ôm…ôd…ô</div>
        <div style="font-size:11px;opacity:0.8;margin-top:3px;">${upcomingPercent}%</div>
    </div>`;

    html += '</div>';

    // Progress bar
    html += '<div style="margin-bottom:20px;">';
    html += '<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:5px;">';
    html += `<span>√úmumi Progress</span><span><strong>${moduleStats.completed}</strong> / ${moduleStats.total} modul</span>`;
    html += '</div>';
    html += '<div style="height:20px;background:#e6edf3;border-radius:10px;overflow:hidden;display:flex;">';
    if (moduleStats.total > 0) {
        html += `<div style="width:${completedPercent}%;background:#10b981;" title="Tamamlandƒ±: ${completedPercent}%"></div>`;
        html += `<div style="width:${inProgressPercent}%;background:#3b82f6;" title="Davam edir: ${inProgressPercent}%"></div>`;
        html += `<div style="width:${upcomingPercent}%;background:#6b7280;" title="G√∂zl…ôm…ôd…ô: ${upcomingPercent}%"></div>`;
    }
    html += '</div></div>';

    // Modul-modul statistika
    html += '<h4 style="margin-top:20px;margin-bottom:10px;">Modul √ºzr…ô t…ôf…ôrr√ºat:</h4>';
    html += '<div style="display:grid;gap:8px;max-height:300px;overflow-y:auto;padding-right:5px;">';

    Object.keys(moduleDetails).forEach(moduleName => {
        const stats = moduleDetails[moduleName];
        const total = stats.completed + stats.inProgress + stats.upcoming;
        const completedPct = ((stats.completed / total) * 100).toFixed(0);

        html += `<div style="padding:10px;background:#f9fafb;border-radius:6px;border-left:4px solid #3b82f6;">
            <div style="font-weight:600;font-size:13px;margin-bottom:6px;">${moduleName}</div>
            <div style="display:flex;gap:10px;font-size:11px;">
                <span style="color:#10b981;">‚úì ${stats.completed}</span>
                <span style="color:#3b82f6;">üîÑ ${stats.inProgress}</span>
                <span style="color:#6b7280;">‚è≥ ${stats.upcoming}</span>
                <span style="margin-left:auto;font-weight:600;color:var(--muted);">${completedPct}% tamamlandƒ±</span>
            </div>
            <div style="height:4px;background:#e6edf3;border-radius:2px;overflow:hidden;margin-top:6px;">
                <div style="width:${completedPct}%;height:100%;background:#10b981;"></div>
            </div>
        </div>`;
    });

    html += '</div>';
    html += '</div>';
    return html;
}

// üì§ EXCEL-D∆èN ƒ∞MPORT ET
const importAllDataBtn = document.getElementById('importAllDataBtn');
const importFileInput = document.getElementById('importFileInput');

importAllDataBtn.onclick = () => {
  importFileInput.click(); // Fayl se√ßim p…ônc…ôr…ôsini a√ß
};

importFileInput.onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (event) => {
    try {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, { type: 'array' });

      console.log('üìä Excel oxunur...');
      console.log('Sheet adlarƒ±:', workbook.SheetNames);

      // ========== 1. QRUPLARI OXU ==========
      const groupsSheet = workbook.Sheets['Qruplar'];
      if (groupsSheet) {
        const groupsData = XLSX.utils.sheet_to_json(groupsSheet);
        console.log('üìö Qruplar tapƒ±ldƒ±:', groupsData.length);
        
        groupsData.forEach(row => {
          const groupName = row['Qrup Adƒ±'];
          let existingGroup = state.groups.find(g => g.name === groupName);
          
          // Tarixi d√ºzg√ºn oxu (Excel serial number olabil…ôr)
          let startDate = row['Ba≈ülanƒüƒ±c'];
          if (typeof startDate === 'number') {
            // Excel serial number-u tarix…ô √ßevir
            const excelEpoch = new Date(1899, 11, 30);
            const date = new Date(excelEpoch.getTime() + startDate * 86400000);
            startDate = formatDateDMY(date);
          } else if (startDate) {
            startDate = startDate.toString().trim();
          }
          
          console.log(`üìÖ ${groupName} ba≈ülanƒüƒ±c tarixi: ${startDate}`);
          
          if (!existingGroup) {
            // Yeni qrup …ôlav…ô et
            const newGroup = {
              name: groupName,
              code: row['Kod'],
              startDate: startDate,
              moduleCount: row['Modul Sayƒ±'] || 5,
              archived: row['Status'] === 'Arxiv',
              moduleHours: {},
              assignments: {},
              taAssignments: {},
              weeklyNotes: {}
            };
            state.groups.push(newGroup);
            existingGroup = newGroup;
          } else {
            // M√∂vcud qrupu yenil…ô
            existingGroup.code = row['Kod'];
            existingGroup.startDate = row['Ba≈ülanƒüƒ±c'];
            existingGroup.moduleCount = row['Modul Sayƒ±'] || 5;
            existingGroup.archived = row['Status'] === 'Arxiv';
          }
        });
      }

      // ========== 2. M√ú∆èLLƒ∞ML∆èRƒ∞ OXU ==========
      const teachersSheet = workbook.Sheets['M√º…ôlliml…ôr'];
      if (teachersSheet) {
        const teachersData = XLSX.utils.sheet_to_json(teachersSheet);
        console.log('üë• M√º…ôlliml…ôr tapƒ±ldƒ±:', teachersData.length);
        
        teachersData.forEach(row => {
          const teacherName = row['Ad Soyad'];
          const exists = state.teachers.find(t => t.name === teacherName);
          
          if (!exists) {
            let role = 'teacher';
            if (row['Rol'] === 'TA') role = 'ta';
            else if (row['Rol'] === 'M√º…ôllim/TA') role = 'both';
            
            state.teachers.push({
              name: teacherName,
              role: role,
              email: row['Email'] || '',
              phone: row['Telefon'] || '',
              note: row['Qeyd'] || ''
            });
          }
        });
      }

      // ========== 3. H∆èR QRUPUN MODUL T∆èYƒ∞NATLARINI OXU ==========
      // ========== 3. H∆èR QRUPUN MODUL T∆èYƒ∞NATLARINI OXU ==========
      workbook.SheetNames.forEach(sheetName => {
        // Qrup sheet-l…ôrini tap (Qruplar, M√º…ôlliml…ôr v…ô s. deyil)
        if (sheetName !== 'Qruplar' && 
            sheetName !== 'M√º…ôlliml…ôr' && 
            sheetName !== 'H…ôft…ôlik Qeydl…ôr' && 
            sheetName !== 'Bayramlar' && 
            !sheetName.includes('Qiymet')) {
          
          const moduleSheet = workbook.Sheets[sheetName];
          const allRows = XLSX.utils.sheet_to_json(moduleSheet, { header: 1, defval: '' });
          
          console.log(`üìñ ${sheetName} sheet oxunur...`, allRows);
          
          if (allRows.length > 0) {
            // ƒ∞lk s…ôtird…ôn qrup adƒ±nƒ± tap (m…ôs: "Qrup: CS1-Az")
            let groupName = sheetName;
            const firstRowText = allRows[0].join(' ');
            const groupMatch = firstRowText.match(/Qrup:\s*([^\s,]+)/i);
            if (groupMatch) {
              groupName = groupMatch[1];
            }
            
            console.log(`üéØ Qrup adƒ±: ${groupName}`);
            
            // State-d…ôn qrupu tap
            const group = state.groups.find(g => g.name === groupName);
            
            if (group) {
              console.log(`‚úÖ Qrup tapƒ±ldƒ±: ${groupName}`);
              
              // Assignments v…ô TA assignments-i t…ômizl…ô
              group.assignments = {};
              group.taAssignments = {};
              group.moduleHours = {};
              
              // Modul s…ôtrl…ôrini tap (header-d…ôn sonra)
              let dataStartRow = -1;
              for (let i = 0; i < allRows.length; i++) {
                const row = allRows[i];
                if (row[0] && row[0].toString().toLowerCase().includes('modul')) {
                  dataStartRow = i + 1;
                  break;
                }
              }
              
              if (dataStartRow === -1) {
                console.warn(`‚ö†Ô∏è ${groupName} √º√ß√ºn modul header tapƒ±lmadƒ±`);
                return;
              }
              
              console.log(`üìä Data ba≈ülanƒüƒ±c s…ôtir: ${dataStartRow}`);
              
              // Modullarƒ± oxu
              for (let i = dataStartRow; i < allRows.length; i++) {
                const row = allRows[i];
                
                // Bo≈ü s…ôtri ke√ß
                if (!row || row.length === 0 || !row[0]) continue;
                
                const moduleName = row[0]?.toString().trim();
                const startDate = row[1]?.toString().trim();
                const endDate = row[2]?.toString().trim();
                const hours = row[3];
                const daysUsed = row[4];
                const teacher = row[5]?.toString().trim();
                const ta = row[6]?.toString().trim();
                
                console.log(`üìù S…ôtir ${i}:`, { moduleName, hours, teacher, ta });
                
                // ∆èg…ôr modul adƒ± varsa
                if (moduleName && moduleName !== '-' && moduleName !== '') {
                  // Saatlarƒ± saxla
                  if (hours && !isNaN(hours) && hours > 0) {
                    group.moduleHours[moduleName] = Number(hours);
                    console.log(`‚è∞ ${moduleName} √º√ß√ºn saat: ${hours}`);
                  }
                  
                  // M√º…ôllimi t…ôyin et (6-cƒ± s√ºtun)
if (teacher && teacher !== '-' && teacher !== '' && teacher.trim() !== '') {
  group.assignments[moduleName] = teacher.trim();
  console.log(`üë®‚Äçüè´ ${moduleName} √º√ß√ºn m√º…ôllim: ${teacher.trim()}`);
}

// TA-nƒ± t…ôyin et (7-ci s√ºtun)
if (ta && ta !== '-' && ta !== '' && ta.trim() !== '') {
  group.taAssignments[moduleName] = ta.trim();
  console.log(`üë• ${moduleName} √º√ß√ºn TA: ${ta.trim()}`);
}
                }
              }
              
              console.log(`‚úÖ ${groupName} √º√ß√ºn t…ôyinatlar y√ºkl…ôndi:`, 
                          Object.keys(group.assignments).length, 'm√º…ôllim,',
                          Object.keys(group.taAssignments).length, 'TA,',
                          Object.keys(group.moduleHours).length, 'modul saatƒ±');
            } else {
              console.error(`‚ùå Qrup tapƒ±lmadƒ±: ${groupName}`);
            }
          }
        }
      });

      // ========== 4. H∆èFT∆èLIK QEYDL∆èRI OXU ==========
      const notesSheet = workbook.Sheets['H…ôft…ôlik Qeydl…ôr'];
      if (notesSheet) {
        const notesData = XLSX.utils.sheet_to_json(notesSheet);
        console.log('üìù H…ôft…ôlik qeydl…ôr tapƒ±ldƒ±:', notesData.length);
        
        notesData.forEach(row => {
          const groupName = row['Qrup'];
          const group = state.groups.find(g => g.name === groupName);
          
          if (group) {
            if (!group.weeklyNotes) group.weeklyNotes = {};
            
            let status = 'yellow';
            if (row['Status'] === 'H…ôll olundu') status = 'green';
            else if (row['Status'] === 'Bu h…ôft…ô H∆èLL') status = 'orange';
            
            group.weeklyNotes[row['Tarix']] = {
              status: status,
              text: row['Qeyd'] || ''
            };
          }
        });
      }
// ========== 4.5. T∆èQVIM G√úN T∆èYƒ∞NATLARINI OXU ==========
const dayAssignSheet = workbook.Sheets['G√ºn T…ôyinatlarƒ±'];
if (dayAssignSheet) {
  const dayAssignData = XLSX.utils.sheet_to_json(dayAssignSheet);
  console.log('üìÖ G√ºn t…ôyinatlarƒ± tapƒ±ldƒ±:', dayAssignData.length);
  
  if (!state.dayAssignments) state.dayAssignments = {};
  
  dayAssignData.forEach(row => {
    const groupName = row['Qrup'];
    const date = row['Tarix'];
    const teacher = row['M√º…ôllim'] || '';
    const ta = row['TA'] || '';
    
    const dayKey = `${groupName}_${date}`;
    
    state.dayAssignments[dayKey] = {
      teacher: teacher,
      ta: ta,
      date: date,
      groupName: groupName
    };
    
    console.log(`‚úÖ ${dayKey} √º√ß√ºn t…ôyinat: ${teacher} / ${ta}`);
  });
}
      // ========== 5. BAYRAYLARI OXU ==========
      const holidaysSheet = workbook.Sheets['Bayramlar'];
      if (holidaysSheet) {
        const holidaysData = XLSX.utils.sheet_to_json(holidaysSheet);
        console.log('üéâ Bayramlar tapƒ±ldƒ±:', holidaysData.length);
        
        state.nonWorkingHolidays = [];
        state.customHolidays = [];
        
        holidaysData.forEach(row => {
          if (row['Se√ßilib'] === 'B…ôli') {
            state.nonWorkingHolidays.push(row['Tarix']);
          }
          
          if (row['Bayram Adƒ±'] && row['Bayram Adƒ±'].includes('(X√ºsusi)')) {
            state.customHolidays.push({
              date: row['Tarix'],
              name: row['Bayram Adƒ±'].replace(' (X√ºsusi)', '')
            });
          }
        });
      }
      // ========== 6. Qƒ∞YM∆èTL∆èNDƒ∞RM∆è M∆èLUMATLARINI OXU ==========
      workbook.SheetNames.forEach(sheetName => {
        if (sheetName.includes('Qiymet')) {
          const gradingSheet = workbook.Sheets[sheetName];
          const gradingData = XLSX.utils.sheet_to_json(gradingSheet, { header: 1 });
          
          if (gradingData.length > 2) {
            const groupName = sheetName.replace(' Qiymet', '').trim();
            console.log(`üìä ${groupName} qiym…ôtl…ôri oxunur...`);
            
            if (!state.grading) state.grading = {};
            if (!state.grading[groupName]) {
              state.grading[groupName] = { students: [], assessments: [] };
            }
            
            // Header s…ôtirini oxu (assessment adlarƒ±)
            const headerRow = gradingData[2];
            const assessmentNames = headerRow.slice(1); // "T…ôl…ôb…ô" s√ºtununu ke√ß
            
            // Assessment-l…ôri yarat
            state.grading[groupName].assessments = [];
            assessmentNames.forEach(name => {
              if (name) {
                state.grading[groupName].assessments.push({
                  name: name,
                  date: '',
                  grades: {}
                });
              }
            });
            
            // T…ôl…ôb…ô s…ôtirl…ôri (3-c√º s…ôtird…ôn sonra)
            for (let i = 3; i < gradingData.length; i++) {
              const row = gradingData[i];
              const studentName = row[0];
              
              if (studentName) {
                // T…ôl…ôb…ôni …ôlav…ô et
                if (!state.grading[groupName].students.includes(studentName)) {
                  state.grading[groupName].students.push(studentName);
                }
                
                // Qiym…ôtl…ôri …ôlav…ô et
                for (let j = 1; j < row.length; j++) {
                  const grade = row[j];
                  const assessmentIndex = j - 1;
                  
                  if (grade && state.grading[groupName].assessments[assessmentIndex]) {
                    state.grading[groupName].assessments[assessmentIndex].grades[studentName] = grade;
                  }
                }
              }
            }
            
            console.log(`‚úÖ ${groupName}: ${state.grading[groupName].students.length} t…ôl…ôb…ô, ${state.grading[groupName].assessments.length} qiym…ôtl…ôndirm…ô`);
          }
        }
      });

      // ========== DATANI FIREBASE-∆è SAXLA ==========
      console.log('üíæ Firebase-…ô yazƒ±lƒ±r...');
      await saveState();
      
      // ========== S∆èHƒ∞F∆èNƒ∞ YENƒ∞L∆è ==========
      console.log('üîÑ S…ôhif…ô yenil…ônir...');
      renderGroups();
      renderTeachers();
      renderHolidays();
      renderDashboard();
      
      alert('‚úÖ B√ºt√ºn datalar uƒüurla y√ºkl…ôndi v…ô Firebase-…ô yazƒ±ldƒ±!\n\n' +
            'üìö Qruplar: ' + state.groups.length + '\n' +
            'üë• M√º…ôlliml…ôr: ' + state.teachers.length + '\n' +
            'üéâ Bayramlar: ' + state.nonWorkingHolidays.length);
      
      // Input-u t…ômizl…ô
      importFileInput.value = '';
      
    } catch (error) {
      console.error('‚ùå ƒ∞mport x…ôtasƒ±:', error);
      alert('‚ùå X…ôta ba≈ü verdi: ' + error.message + '\n\nKonsola bax (F12)');
    }
  };

  reader.readAsArrayBuffer(file);
};

</script>
</body>
</html>
<!-- Hƒ∞SS∆è 3/3 SONU -->
